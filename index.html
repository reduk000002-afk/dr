<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отправка USDT через Trust Wallet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <!-- Встроенная библиотека QRCode (чтобы работало локально) -->
    <script>
        !function(e){"use strict";function t(t){if(t){var o=e.document.createElement("p"),n=e.document.getElementsByTagName("head")[0]||e.document.documentElement;o.innerHTML='x<style>'+t+"</style>",n.insertBefore(o.lastChild,n.firstChild)}}if(void 0===e.QRCode){var o=!0,n=!1,r=null,i=null,s=null,a=function(){if(o){var t=e.document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js",t.onload=function(){o=!1},t.onerror=function(){o=!1,n=!0},e.document.getElementsByTagName("head")[0].appendChild(t)}};e.QRCode={toCanvas:function(t,o,n){return a(),r||(r=function(t,o){if(n)return;var r=e.document.createElement("canvas");return o&&o.width&&(r.width=o.width),o&&o.height&&(r.height=o.height),new Promise(function(e,n){QRCode.toCanvas(r,t,o,function(t){t?n(t):e(r)})})}),r.apply(this,arguments)},toDataURL:function(t,o,n){return a(),i||(i=function(t,o){if(n)return;new Promise(function(e,n){QRCode.toDataURL(t,o,function(t,o){t?n(t):e(o)})})}),i.apply(this,arguments)},toString:function(t,o,n){return a(),s||(s=function(t,o){if(n)return;new Promise(function(e,n){QRCode.toString(t,o,function(t,o){t?n(t):e(o)})})}),s.apply(this,arguments)}},e.QRCode.apply=function(t,o){return t.apply(e,o)},t(".qrcode{position:relative}.qrcode canvas,.qrcode img{position:absolute;left:0;top:0;width:100%;height:100%}"),setTimeout(function(){o&&!n&&t(".qrcode{min-height:64px;background:url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIGZpbGw9IiNGRkYiLz48cGF0aCBkPSJNMzIgMEMxNC4zIDAgMCAxNC4zIDAgMzJzMTQuMyAzMiAzMiAzMiAzMi0xNC4zIDMyLTMyUzQ5LjcgMCAzMiAwem0wIDYxLjJjLTE2LjEgMC0yOS4yLTEzLjEtMjkuMi0yOS4yUzE1LjkgMi44IDMyIDIuOHMyOS4yIDEzLjEgMjkuMiAyOS4yLTEzLjEgMjkuMi0yOS4yIDI5LjJ6IiBmaWxsPSIjMDAwIiBmaWxsLW9wYWNpdHk9Ii4wNSIvPjxjaXJjbGUgY3g9IjMyIiBjeT0iMzIiIHI9IjUuNiIgZmlsbD0iIzAwMCIgZmlsbC1vcGFjaXR5PSIuMDUiLz48L3N2Zz4=') no-repeat 50% 50%}")},3e3)}}(self);
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #f1f5f9; min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; padding: 25px; background: rgba(30,41,59,0.7); border-radius: 20px; border: 1px solid rgba(100,116,139,0.3); }
        h1 { color: #3b82f6; font-size: 2.2rem; margin-bottom: 10px; }
        .card { background: rgba(30,41,59,0.8); border-radius: 15px; padding: 25px; margin-bottom: 20px; border: 1px solid rgba(100,116,139,0.3); }
        .status-card { display: flex; align-items: center; justify-content: space-between; gap: 20px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; background: #ef4444; }
        .status-indicator.connected { background: #10b981; box-shadow: 0 0 10px #10b981; }
        .btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(59,130,246,0.4); }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(16,185,129,0.4); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
        .btn-outline { background: transparent; border: 2px solid rgba(255,255,255,0.2); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        .wallet-details { margin: 20px 0; }
        .detail { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .detail:last-child { border-bottom: none; }
        .label { color: #94a3b8; font-weight: 500; }
        .value { color: #f1f5f9; font-weight: 600; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #e2e8f0; }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid rgba(100,116,139,0.5); background: rgba(15,23,42,0.7); color: white; font-size: 1rem; }
        input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .summary { background: rgba(15,23,42,0.7); padding: 15px; border-radius: 10px; margin: 20px 0; }
        .summary-item { display: flex; justify-content: space-between; padding: 8px 0; }
        .log-entry { padding: 10px; margin: 10px 0; border-radius: 10px; background: rgba(15,23,42,0.5); border-left: 4px solid #3b82f6; }
        .log-entry.success { border-left-color: #10b981; }
        .log-entry.error { border-left-color: #ef4444; }
        .log-entry.warning { border-left-color: #f59e0b; }
        .warning-box { background: rgba(245,158,11,0.1); border: 1px solid #f59e0b; padding: 15px; border-radius: 10px; margin-top: 20px; color: #fbbf24; }
        .info-box { background: rgba(59,130,246,0.1); border: 1px solid #3b82f6; padding: 15px; border-radius: 10px; margin-top: 20px; color: #93c5fd; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: rgba(30,41,59,0.95); border-radius: 20px; padding: 30px; width: 90%; max-width: 500px; border: 1px solid rgba(100,116,139,0.5); }
        .modal-step { text-align: center; padding: 30px 20px; display: none; }
        .modal-step.active { display: block; }
        .fa-spin { animation: fa-spin 2s infinite linear; }
        @keyframes fa-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .qr-container { text-align: center; padding: 20px; background: white; border-radius: 10px; margin: 20px 0; min-height: 250px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .qr-image { max-width: 200px; height: auto; }
        .token-balance { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(15,23,42,0.5); border-radius: 10px; margin: 10px 0; }
        .connection-uri { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin: 10px 0; word-break: break-all; font-size: 0.8rem; }
        @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } .status-card { flex-direction: column; text-align: center; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-coins"></i> Отправка USDT (BEP-20)</h1>
            <p class="subtitle">Подключите Trust Wallet через QR-код и отправьте USDT</p>
        </header>

        <div class="card status-card">
            <div><div class="status-indicator" id="status-indicator"></div></div>
            <div class="status-text" style="flex: 1;">
                <span id="status-text" style="font-weight: 600;">Отключено</span>
                <small id="network-info" style="display: block; color: #94a3b8; margin-top: 5px;">Ожидание подключения...</small>
            </div>
            <button id="connect-btn" class="btn btn-primary">
                <i class="fas fa-qrcode"></i> Подключить через QR-код
            </button>
        </div>

        <div class="card" id="wallet-card" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3><i class="fas fa-wallet"></i> Ваш кошелек</h3>
                <button id="copy-address" class="btn btn-secondary" style="padding: 8px 16px;">
                    <i class="far fa-copy"></i> Копировать адрес
                </button>
            </div>
            
            <div class="wallet-details">
                <div class="detail">
                    <span class="label">Адрес BSC:</span>
                    <span class="value" id="wallet-address">0x...</span>
                </div>
                <div class="detail">
                    <span class="label">Баланс BNB:</span>
                    <span class="value" id="wallet-balance">0 BNB</span>
                </div>
                <div class="token-balance">
                    <i class="fas fa-dollar-sign" style="color: #26a17b; font-size: 1.5rem;"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">USDT Balance</div>
                        <div id="usdt-balance" style="font-size: 1.2rem; font-weight: 700;">0 USDT</div>
                    </div>
                    <button id="refresh-usdt" class="btn btn-secondary" style="padding: 6px 12px;">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="detail">
                    <span class="label">Сеть:</span>
                    <span class="value" id="wallet-network">Не подключено</span>
                </div>
            </div>
            
            <button id="disconnect-btn" class="btn btn-outline" style="width: 100%; margin-top: 15px;">
                <i class="fas fa-sign-out-alt"></i> Отключиться
            </button>
        </div>

        <div class="card" id="send-card" style="display: none;">
            <h3 style="margin-bottom: 20px; color: #26a17b;">
                <i class="fas fa-paper-plane"></i> Отправить USDT (BEP-20)
            </h3>
            
            <div class="form-group">
                <label for="receiver-address">
                    <i class="fas fa-user-friends"></i> Адрес получателя (BSC):
                </label>
                <input type="text" id="receiver-address" placeholder="0x..." 
                       value="0x55d398326f99059fF775485246999027B3197955">
                <small style="color: #94a3b8; display: block; margin-top: 5px;">
                    Введите адрес кошелька BSC (начинается с 0x)
                </small>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="amount"><i class="fas fa-coins"></i> Количество USDT:</label>
                    <input type="number" id="amount" step="0.01" min="0.01" value="1.00" placeholder="1.00">
                </div>
                
                <div class="form-group">
                    <label for="network-select"><i class="fas fa-network-wired"></i> Сеть:</label>
                    <select id="network-select">
                        <option value="bsc">BSC Mainnet (реальная сеть)</option>
                        <option value="bsctest">BSC Testnet (тестовая)</option>
                    </select>
                </div>
            </div>
            
            <div class="summary">
                <h4 style="margin-bottom: 15px; color: #e2e8f0;">
                    <i class="fas fa-calculator"></i> Детали транзакции:
                </h4>
                <div class="summary-item">
                    <span>Сумма USDT:</span>
                    <span id="usdt-amount">1.00 USDT</span>
                </div>
                <div class="summary-item">
                    <span>Комиссия сети (BNB):</span>
                    <span id="gas-fee">~ 0.0012 BNB</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button id="send-usdt-btn" class="btn btn-success" style="flex: 1;">
                    <i class="fas fa-paper-plane"></i> Отправить USDT
                </button>
                <button id="check-balance-btn" class="btn btn-secondary">
                    <i class="fas fa-sync-alt"></i> Проверить
                </button>
            </div>
        </div>

        <div class="card" id="log-card">
            <h3><i class="fas fa-history"></i> История операций</h3>
            <div class="log-entries" id="log-entries" style="max-height: 300px; overflow-y: auto; padding: 10px;">
                <div class="log-entry">
                    <i class="fas fa-info-circle"></i>
                    <span>Готов к работе. Нажмите "Подключить через QR-код".</span>
                </div>
            </div>
        </div>

        <div class="card info-box">
            <h3><i class="fas fa-info-circle"></i> Как подключить:</h3>
            <ol style="margin-left: 20px; margin-top: 10px;">
                <li><strong>Нажмите "Подключить через QR-код"</strong></li>
                <li><strong>Появится QR-код и ссылка</strong></li>
                <li><strong>На телефоне:</strong> Откройте Trust Wallet</li>
                <li><strong>Настройки → WalletConnect → Новое соединение</strong></li>
                <li><strong>Отсканируйте QR-код</strong> или вставьте ссылку</li>
                <li><strong>Подтвердите подключение</strong> в Trust Wallet</li>
            </ol>
        </div>

        <div class="card warning-box">
            <h3><i class="fas fa-exclamation-triangle"></i> Важная информация:</h3>
            <p style="margin: 10px 0;">
                <strong>Адрес контракта USDT (BEP-20):</strong><br>
                <code style="background: rgba(0,0,0,0.3); padding: 5px; border-radius: 5px; font-size: 0.9rem;">
                    0x55d398326f99059fF775485246999027B3197955
                </code>
            </p>
            <p style="margin: 10px 0;">
                Для отправки USDT вам необходимо иметь BNB для оплаты комиссии.
            </p>
        </div>
    </div>

    <!-- Модальное окно для QR-кода -->
    <div class="modal" id="qr-modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #3b82f6;">
                    <i class="fas fa-qrcode"></i> Подключение Trust Wallet
                </h3>
                <button onclick="closeQRModal()" style="background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer;">
                    &times;
                </button>
            </div>
            
            <div style="text-align: center;">
                <p><strong>Отсканируйте QR-код в Trust Wallet:</strong></p>
                
                <div id="qr-container" class="qr-container">
                    <div id="qr-loading">
                        <i class="fas fa-spinner fa-spin fa-2x" style="color: #3b82f6;"></i>
                        <p style="margin-top: 10px;">Генерация QR-кода...</p>
                    </div>
                    <div id="qr-result" style="display: none;">
                        <div id="qr-image"></div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <p><strong>Или скопируйте ссылку:</strong></p>
                    <div id="connection-uri-display" class="connection-uri">
                        Ожидание генерации...
                    </div>
                    <button onclick="copyConnectionURI()" class="btn btn-primary">
                        <i class="fas fa-copy"></i> Скопировать ссылку
                    </button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(15,23,42,0.5); border-radius: 10px;">
                    <h4>Инструкция для Trust Wallet:</h4>
                    <ol style="text-align: left; margin-left: 20px; margin-top: 10px;">
                        <li>Откройте <strong>Trust Wallet</strong> на телефоне</li>
                        <li>Нажмите <strong>⚙️ Настройки</strong></li>
                        <li>Выберите <strong>WalletConnect</strong></li>
                        <li>Нажмите <strong>"Новое соединение"</strong></li>
                        <li><strong>Вариант А:</strong> Отсканируйте QR-код</li>
                        <li><strong>Вариант Б:</strong> Нажмите "Вставить из буфера"</li>
                    </ol>
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="simulateConnection()" class="btn btn-secondary">
                        <i class="fas fa-vial"></i> Тестовое подключение (демо)
                    </button>
                    <button onclick="useBrowserWallet()" class="btn btn-outline" style="margin-left: 10px;">
                        <i class="fas fa-desktop"></i> Использовать браузерный кошелек
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно транзакции -->
    <div class="modal" id="tx-modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="modal-title" style="margin: 0; color: #3b82f6;">
                    <i class="fas fa-sync fa-spin"></i> Отправка USDT
                </h3>
                <button onclick="closeModal()" style="background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer;">
                    &times;
                </button>
            </div>
            
            <div class="modal-body">
                <div class="modal-step active" id="step-sign">
                    <i class="fas fa-file-signature fa-spin" style="color: #f59e0b;"></i>
                    <h4>Ожидание подписи...</h4>
                    <p>Подтвердите транзакцию в Trust Wallet</p>
                </div>
                
                <div class="modal-step" id="step-sending">
                    <i class="fas fa-paper-plane fa-spin" style="color: #3b82f6;"></i>
                    <h4>Отправка в сеть...</h4>
                    <p id="tx-hash-text" style="word-break: break-all; font-size: 0.9rem; margin-top: 10px;">
                        Хэш транзакции появится здесь
                    </p>
                </div>
                
                <div class="modal-step" id="step-success">
                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                    <h4>Успешно отправлено!</h4>
                    <p id="success-details" style="margin-top: 10px;"></p>
                    <a id="tx-explorer-link" href="#" target="_blank" 
                       style="display: inline-block; margin-top: 15px; color: #3b82f6; text-decoration: none;">
                       <i class="fas fa-external-link-alt"></i> Открыть в BscScan
                    </a>
                </div>
                
                <div class="modal-step" id="step-error">
                    <i class="fas fa-times-circle" style="color: #ef4444;"></i>
                    <h4>Ошибка</h4>
                    <p id="error-details" style="margin-top: 10px;"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== КОНСТАНТЫ ==========
        const CONTRACT_ADDRESSES = {
            bsc: '0x55d398326f99059fF775485246999027B3197955', // USDT BEP-20 Mainnet
            bsctest: '0x337610d27c682E347C9cD60BD4b3b107C9d34dDd' // USDT BEP-20 Testnet
        };
        
        const USDT_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)",
            "function name() view returns (string)"
        ];
        
        // ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
        let connector = null;
        let provider = null;
        let signer = null;
        let userAddress = null;
        let chainId = null;
        let usdtContract = null;
        let currentNetwork = 'bsc';
        let currentURI = '';
        let walletConnectLoaded = false;
        
        // ========== ЭЛЕМЕНТЫ DOM ==========
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const sendUsdtBtn = document.getElementById('send-usdt-btn');
        const checkBalanceBtn = document.getElementById('check-balance-btn');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const networkInfo = document.getElementById('network-info');
        const walletCard = document.getElementById('wallet-card');
        const sendCard = document.getElementById('send-card');
        const walletAddress = document.getElementById('wallet-address');
        const walletBalance = document.getElementById('wallet-balance');
        const usdtBalance = document.getElementById('usdt-balance');
        const walletNetwork = document.getElementById('wallet-network');
        const receiverAddress = document.getElementById('receiver-address');
        const amountInput = document.getElementById('amount');
        const networkSelect = document.getElementById('network-select');
        const logEntries = document.getElementById('log-entries');
        const txModal = document.getElementById('tx-modal');
        const qrModal = document.getElementById('qr-modal');
        const refreshUsdtBtn = document.getElementById('refresh-usdt');
        const qrLoading = document.getElementById('qr-loading');
        const qrResult = document.getElementById('qr-result');
        const qrImage = document.getElementById('qr-image');
        const connectionURIDisplay = document.getElementById('connection-uri-display');
        
        // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
        function addLog(message, type = 'info') {
            const icon = {
                'success': 'check-circle',
                'error': 'times-circle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            }[type];
            
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${new Date().toLocaleTimeString()} - ${message}</span>
            `;
            logEntries.prepend(entry);
            
            // Ограничиваем количество записей
            if (logEntries.children.length > 20) {
                logEntries.removeChild(logEntries.lastChild);
            }
        }
        
        function updateUI(connected = false) {
            if (connected) {
                statusIndicator.className = 'status-indicator connected';
                statusText.textContent = 'Подключено';
                statusText.style.color = '#10b981';
                connectBtn.disabled = true;
                walletCard.style.display = 'block';
                sendCard.style.display = 'block';
                disconnectBtn.disabled = false;
                sendUsdtBtn.disabled = false;
                checkBalanceBtn.disabled = false;
            } else {
                statusIndicator.className = 'status-indicator';
                statusText.textContent = 'Отключено';
                statusText.style.color = '#f1f5f9';
                connectBtn.disabled = false;
                walletCard.style.display = 'none';
                sendCard.style.display = 'none';
                disconnectBtn.disabled = true;
                sendUsdtBtn.disabled = true;
                checkBalanceBtn.disabled = true;
            }
        }
        
        function showModalStep(stepId) {
            document.querySelectorAll('.modal-step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(stepId).classList.add('active');
        }
        
        function openModal() {
            txModal.style.display = 'flex';
        }
        
        function closeModal() {
            txModal.style.display = 'none';
        }
        
        function openQRModal() {
            qrModal.style.display = 'flex';
            startWalletConnectConnection();
        }
        
        function closeQRModal() {
            qrModal.style.display = 'none';
            if (connector && connector.connected) {
                connector.killSession();
            }
        }
        
        async function getNetworkName(chainId) {
            const networks = {
                1: 'Ethereum',
                56: 'BNB Smart Chain',
                97: 'BNB Testnet',
                11155111: 'Sepolia',
                5: 'Goerli'
            };
            return networks[chainId] || `Сеть ${chainId}`;
        }
        
        // ========== WALLETCONNECT ПОДКЛЮЧЕНИЕ ==========
        function startWalletConnectConnection() {
            addLog('Начинаем подключение через WalletConnect...', 'info');
            
            // Сбрасываем состояние
            qrLoading.style.display = 'block';
            qrResult.style.display = 'none';
            connectionURIDisplay.textContent = 'Генерация подключения...';
            
            // Пробуем загрузить WalletConnect динамически
            loadWalletConnect().then(success => {
                if (success) {
                    createWalletConnectSession();
                } else {
                    // Если не удалось загрузить, используем ручную генерацию
                    addLog('WalletConnect не загрузился, используем ручной метод', 'warning');
                    generateManualConnection();
                }
            });
        }
        
        function loadWalletConnect() {
            return new Promise((resolve) => {
                // Проверяем, уже загружена ли библиотека
                if (typeof WalletConnect !== 'undefined') {
                    walletConnectLoaded = true;
                    addLog('WalletConnect уже загружен', 'success');
                    resolve(true);
                    return;
                }
                
                addLog('Загружаем WalletConnect библиотеку...', 'info');
                
                // Динамически загружаем библиотеку
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/@walletconnect/client@1.8.0/dist/index.umd.js';
                script.onload = function() {
                    walletConnectLoaded = true;
                    addLog('WalletConnect успешно загружен', 'success');
                    resolve(true);
                };
                script.onerror = function() {
                    addLog('Не удалось загрузить WalletConnect', 'error');
                    resolve(false);
                };
                document.head.appendChild(script);
            });
        }
        
        function createWalletConnectSession() {
            try {
                if (!walletConnectLoaded) {
                    throw new Error('WalletConnect не загружен');
                }
                
                // Создаем коннектор
                connector = new WalletConnect.default({
                    bridge: "https://bridge.walletconnect.org",
                    qrcodeModal: {
                        open: (uri) => {
                            addLog('Получен URI для подключения', 'success');
                            currentURI = uri;
                            generateQRCode(uri);
                        },
                        close: () => {
                            addLog('Модальное окно закрыто', 'info');
                        }
                    }
                });
                
                // Если уже подключен
                if (connector.connected) {
                    onWalletConnectConnected({
                        params: [{
                            accounts: connector.accounts,
                            chainId: connector.chainId
                        }]
                    });
                    return;
                }
                
                // Создаем новую сессию
                connector.createSession({ chainId: 56 })
                    .then(() => {
                        addLog('Сессия WalletConnect создана', 'success');
                        
                        // Подписываемся на события
                        connector.on("connect", (error, payload) => {
                            if (error) {
                                addLog(`Ошибка подключения: ${error.message}`, 'error');
                                return;
                            }
                            onWalletConnectConnected(payload);
                        });
                        
                        connector.on("session_update", (error, payload) => {
                            if (error) {
                                addLog(`Ошибка обновления сессии: ${error.message}`, 'error');
                                return;
                            }
                            addLog('Сессия обновлена', 'info');
                        });
                        
                        connector.on("disconnect", (error, payload) => {
                            if (error) {
                                addLog(`Ошибка отключения: ${error.message}`, 'error');
                                return;
                            }
                            disconnectWallet();
                            addLog('Кошелек отключен', 'info');
                        });
                    })
                    .catch(error => {
                        addLog(`Ошибка создания сессии: ${error.message}`, 'error');
                        generateManualConnection();
                    });
                
            } catch (error) {
                addLog(`Ошибка создания WalletConnect: ${error.message}`, 'error');
                generateManualConnection();
            }
        }
        
        function generateManualConnection() {
            addLog('Используем ручную генерацию подключения', 'info');
            
            // Генерируем URI вручную
            const sessionId = generateRandomId();
            const bridge = 'https://bridge.walletconnect.org';
            const key = generateRandomKey();
            
            const uri = `wc:${sessionId}@1?bridge=${encodeURIComponent(bridge)}&key=${key}`;
            currentURI = uri;
            
            addLog('URI сгенерирован вручную', 'success');
            generateQRCode(uri);
        }
        
        function generateQRCode(uri) {
            addLog('Генерируем QR-код...', 'info');
            
            // Проверяем наличие QRCode
            if (typeof QRCode === 'undefined') {
                addLog('Библиотека QRCode не найдена', 'error');
                showURIText(uri);
                return;
            }
            
            // Генерируем QR-код
            QRCode.toDataURL(uri, {
                width: 200,
                margin: 1,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function(error, url) {
                if (error) {
                    addLog(`Ошибка генерации QR: ${error.message}`, 'error');
                    showURIText(uri);
                } else {
                    addLog('QR-код сгенерирован', 'success');
                    qrLoading.style.display = 'none';
                    qrResult.style.display = 'block';
                    qrImage.innerHTML = `<img src="${url}" class="qr-image" alt="QR Code">`;
                    connectionURIDisplay.textContent = uri.substring(0, 80) + '...';
                }
            });
        }
        
        function showURIText(uri) {
            qrLoading.style.display = 'none';
            qrResult.style.display = 'block';
            qrImage.innerHTML = `
                <div style="color: black; padding: 20px; text-align: center;">
                    <p><strong>Используйте ссылку:</strong></p>
                    <textarea style="width: 100%; height: 80px; font-size: 10px; padding: 10px;">${uri}</textarea>
                    <p><small>Скопируйте и вставьте в Trust Wallet</small></p>
                </div>
            `;
            connectionURIDisplay.textContent = uri;
        }
        
        function copyConnectionURI() {
            if (currentURI) {
                navigator.clipboard.writeText(currentURI)
                    .then(() => {
                        addLog('Ссылка скопирована в буфер обмена', 'success');
                        alert('✅ Ссылка скопирована!\n\nВставьте в Trust Wallet:\n1. Откройте Trust Wallet\n2. Настройки → WalletConnect\n3. Новое соединение\n4. Вставьте ссылку');
                    })
                    .catch(err => {
                        addLog(`Ошибка копирования: ${err.message}`, 'error');
                    });
            }
        }
        
        function onWalletConnectConnected(payload) {
            try {
                const { accounts, chainId: connectedChainId } = payload.params[0];
                userAddress = accounts[0];
                chainId = parseInt(connectedChainId);
                
                addLog(`Trust Wallet подключен: ${userAddress.substring(0, 6)}...`, 'success');
                
                // Создаем провайдер из коннектора
                provider = new ethers.BrowserProvider(connector);
                
                // Закрываем модальное окно
                closeQRModal();
                
                // Инициализируем подписчика и обновляем UI
                initializeWallet();
                
            } catch (error) {
                addLog(`Ошибка после подключения: ${error.message}`, 'error');
            }
        }
        
        async function initializeWallet() {
            try {
                signer = await provider.getSigner();
                await updateWalletInfo();
                updateUI(true);
                initUsdtContract();
                
            } catch (error) {
                addLog(`Ошибка инициализации кошелька: ${error.message}`, 'error');
            }
        }
        
        // Подключение через браузерный кошелек
        async function useBrowserWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    addLog('Браузерный кошелек не найден', 'error');
                    alert('Установите MetaMask или Trust Wallet расширение');
                    return;
                }
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                userAddress = accounts[0];
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                
                const network = await provider.getNetwork();
                chainId = Number(network.chainId);
                
                closeQRModal();
                await updateWalletInfo();
                updateUI(true);
                initUsdtContract();
                
                addLog(`Браузерный кошелек подключен: ${userAddress.substring(0, 6)}...`, 'success');
                
            } catch (error) {
                addLog(`Ошибка подключения браузерного кошелька: ${error.message}`, 'error');
            }
        }
        
        function disconnectWallet() {
            if (connector && connector.connected) {
                connector.killSession();
            }
            connector = null;
            provider = null;
            signer = null;
            userAddress = null;
            usdtContract = null;
            updateUI(false);
            addLog('Кошелек отключен', 'info');
        }
        
        // Тестовое подключение (демо)
        function simulateConnection() {
            closeQRModal();
            
            userAddress = '0x' + Math.random().toString(16).substring(2, 42);
            
            updateUI(true);
            
            walletAddress.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
            walletBalance.textContent = '1.234 BNB';
            usdtBalance.textContent = '100.50 USDT';
            walletNetwork.textContent = 'BNB Smart Chain (тест)';
            
            addLog('Тестовое подключение успешно', 'success');
            addLog('⚠️ Это демо-режим. Для реальных транзакций подключите настоящий кошелек', 'warning');
        }
        
        // ========== РАБОТА С БЛОКЧЕЙНОМ ==========
        async function updateWalletInfo() {
            try {
                if (!userAddress || !provider) return;
                
                const shortAddress = `${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                walletAddress.textContent = shortAddress;
                
                const networkName = await getNetworkName(chainId);
                walletNetwork.textContent = networkName;
                networkInfo.textContent = networkName;
                
                const balance = await provider.getBalance(userAddress);
                const balanceInBnb = ethers.formatEther(balance);
                walletBalance.textContent = `${parseFloat(balanceInBnb).toFixed(6)} BNB`;
                
                if (usdtContract) {
                    await checkUsdtBalance();
                }
                
            } catch (error) {
                console.error('Ошибка обновления информации:', error);
            }
        }
        
        function initUsdtContract() {
            try {
                const contractAddress = CONTRACT_ADDRESSES[currentNetwork];
                usdtContract = new ethers.Contract(contractAddress, USDT_ABI, signer);
                addLog(`Контракт USDT загружен`, 'success');
                checkUsdtBalance();
            } catch (error) {
                console.error('Ошибка инициализации контракта:', error);
                addLog('Ошибка загрузки контракта USDT', 'error');
            }
        }
        
        async function checkUsdtBalance() {
            try {
                if (!usdtContract || !userAddress) return;
                
                const balance = await usdtContract.balanceOf(userAddress);
                const decimals = await usdtContract.decimals();
                const balanceFormatted = ethers.formatUnits(balance, decimals);
                
                usdtBalance.textContent = `${parseFloat(balanceFormatted).toFixed(2)} USDT`;
                addLog(`Баланс USDT: ${parseFloat(balanceFormatted).toFixed(2)} USDT`, 'info');
                
            } catch (error) {
                console.error('Ошибка проверки баланса USDT:', error);
                usdtBalance.textContent = 'Ошибка загрузки';
            }
        }
        
        async function sendUsdt() {
            if (!signer || !usdtContract) {
                addLog('Сначала подключите кошелек', 'error');
                return;
            }
            
            const to = receiverAddress.value.trim();
            const amount = amountInput.value;
            
            if (!to || !to.startsWith('0x') || to.length !== 42) {
                addLog('Некорректный адрес получателя', 'error');
                return;
            }
            
            if (!amount || parseFloat(amount) <= 0) {
                addLog('Введите корректную сумму', 'error');
                return;
            }
            
            try {
                openModal();
                showModalStep('step-sign');
                
                addLog(`Начало отправки ${amount} USDT...`, 'info');
                
                const decimals = await usdtContract.decimals();
                const amountInWei = ethers.parseUnits(amount, decimals);
                
                const tx = await usdtContract.transfer(to, amountInWei);
                addLog(`Транзакция подписана`, 'info');
                
                showModalStep('step-sending');
                document.getElementById('tx-hash-text').textContent = `Хэш: ${tx.hash.substring(0, 30)}...`;
                
                const receipt = await tx.wait();
                
                showModalStep('step-success');
                document.getElementById('success-details').textContent = 
                    `Успешно отправлено ${amount} USDT`;
                
                const explorerLink = currentNetwork === 'bsc' 
                    ? `https://bscscan.com/tx/${tx.hash}`
                    : `https://testnet.bscscan.com/tx/${tx.hash}`;
                
                document.getElementById('tx-explorer-link').href = explorerLink;
                
                addLog(`✅ Успешно отправлено ${amount} USDT!`, 'success');
                
                await updateWalletInfo();
                
                setTimeout(closeModal, 8000);
                
            } catch (error) {
                console.error('Ошибка отправки USDT:', error);
                
                showModalStep('step-error');
                let errorMsg = error.message || 'Неизвестная ошибка';
                
                if (errorMsg.includes('user rejected')) {
                    errorMsg = 'Транзакция отклонена в Trust Wallet';
                } else if (errorMsg.includes('insufficient funds')) {
                    errorMsg = 'Недостаточно BNB для комиссии';
                } else if (errorMsg.includes('insufficient balance')) {
                    errorMsg = 'Недостаточно USDT на балансе';
                }
                
                document.getElementById('error-details').textContent = errorMsg;
                addLog(`❌ Ошибка: ${errorMsg}`, 'error');
            }
        }
        
        // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
        function generateRandomId() {
            return Math.random().toString(36).substring(2, 15) + 
                   Math.random().toString(36).substring(2, 15);
        }
        
        function generateRandomKey() {
            const chars = 'abcdef0123456789';
            let key = '';
            for (let i = 0; i < 64; i++) {
                key += chars[Math.floor(Math.random() * chars.length)];
            }
            return key;
        }
        
        // ========== ИНИЦИАЛИЗАЦИЯ ==========
        document.getElementById('connect-btn').addEventListener('click', openQRModal);
        document.getElementById('disconnect-btn').addEventListener('click', disconnectWallet);
        document.getElementById('send-usdt-btn').addEventListener('click', sendUsdt);
        document.getElementById('check-balance-btn').addEventListener('click', () => {
            checkUsdtBalance();
            addLog('Проверка баланса...', 'info');
        });
        
        document.getElementById('refresh-usdt').addEventListener('click', checkUsdtBalance);
        
        document.getElementById('copy-address').addEventListener('click', () => {
            if (userAddress) {
                navigator.clipboard.writeText(userAddress);
                addLog('Адрес скопирован в буфер обмена', 'success');
            }
        });
        
        amountInput.addEventListener('input', () => {
            document.getElementById('usdt-amount').textContent = `${amountInput.value} USDT`;
        });
        
        networkSelect.addEventListener('change', (e) => {
            currentNetwork = e.target.value;
            if (usdtContract) {
                initUsdtContract();
            }
        });
        
        // При загрузке страницы
        window.addEventListener('load', () => {
            document.getElementById('usdt-amount').textContent = `${amountInput.value} USDT`;
            addLog('Сайт загружен. Готов к подключению Trust Wallet.', 'info');
        });
    </script>
</body>
</html>
