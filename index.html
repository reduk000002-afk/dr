<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Отправка USDT (BEP-20) через Trust Wallet</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
<style>
  body {
    background: #121212;
    color: white;
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 20px auto;
    padding: 10px;
  }
  input, button {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border-radius: 6px;
    border: none;
    font-size: 16px;
  }
  button {
    background-color: #3b99fc;
    color: white;
    cursor: pointer;
  }
  button:disabled {
    background-color: #666;
    cursor: not-allowed;
  }
  .status {
    margin: 10px 0;
    padding: 12px;
    border-radius: 8px;
    background: #222;
  }
</style>
</head>
<body>

<h1>Отправка USDT (BEP-20) через Trust Wallet</h1>

<div class="status" id="status">Не подключено</div>

<button id="connectBtn">Подключиться к Trust Wallet</button>

<div id="walletSection" style="display:none;">
  <p><strong>Ваш адрес:</strong> <span id="userAddress"></span></p>
  <p><strong>Баланс USDT:</strong> <span id="usdtBalance">0</span></p>

  <label>Адрес получателя USDT:</label>
  <input type="text" id="receiverAddress" placeholder="0x..." />

  <label>Сумма USDT для отправки:</label>
  <input type="number" id="sendAmount" step="0.0001" min="0" placeholder="0.0" />

  <button id="sendBtn">Отправить USDT</button>
</div>

<script>
  const USDT_ADDRESS = "0x55d398326f99059fF775485246999027B3197955";
  const USDT_ABI = [
    "function decimals() view returns (uint8)",
    "function balanceOf(address) view returns (uint256)",
    "function transfer(address to, uint amount) returns (bool)"
  ];

  let provider;
  let signer;
  let usdtContract;

  const connectBtn = document.getElementById("connectBtn");
  const walletSection = document.getElementById("walletSection");
  const statusDiv = document.getElementById("status");
  const userAddressSpan = document.getElementById("userAddress");
  const usdtBalanceSpan = document.getElementById("usdtBalance");
  const receiverInput = document.getElementById("receiverAddress");
  const amountInput = document.getElementById("sendAmount");
  const sendBtn = document.getElementById("sendBtn");

  connectBtn.onclick = async () => {
    try {
      statusDiv.textContent = "Подключение...";
      
      // Создаем провайдера WalletConnect с твоим projectId
      const walletConnectProvider = new WalletConnectProvider.default({
        projectId: "6035d04bd27909e21d106b345131f578",
        chains: [56], // Binance Smart Chain mainnet
        showQrModal: true,
      });

      await walletConnectProvider.enable();

      provider = new ethers.BrowserProvider(walletConnectProvider);
      signer = await provider.getSigner();

      const userAddress = await signer.getAddress();
      userAddressSpan.textContent = userAddress;

      usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);

      walletSection.style.display = "block";
      connectBtn.disabled = true;
      connectBtn.textContent = "Подключено";

      statusDiv.textContent = "Подключено к кошельку";

      await updateBalance();

    } catch (e) {
      statusDiv.textContent = "Ошибка подключения: " + e.message;
      console.error(e);
    }
  };

  async function updateBalance() {
    try {
      const decimals = await usdtContract.decimals();
      const userAddress = await signer.getAddress();
      const balanceRaw = await usdtContract.balanceOf(userAddress);
      const balance = ethers.formatUnits(balanceRaw, decimals);
      usdtBalanceSpan.textContent = balance;
    } catch (e) {
      usdtBalanceSpan.textContent = "Ошибка";
      console.error(e);
    }
  }

  sendBtn.onclick = async () => {
    const to = receiverInput.value.trim();
    const amountStr = amountInput.value.trim();

    if (!ethers.isAddress(to)) {
      alert("Введите корректный адрес получателя");
      return;
    }

    if (isNaN(amountStr) || Number(amountStr) <= 0) {
      alert("Введите корректную сумму");
      return;
    }

    try {
      sendBtn.disabled = true;
      sendBtn.textContent = "Отправка...";

      const decimals = await usdtContract.decimals();
      const amount = ethers.parseUnits(amountStr, decimals);

      const balanceRaw = await usdtContract.balanceOf(await signer.getAddress());
      if (balanceRaw < amount) {
        alert("Недостаточно USDT на балансе");
        sendBtn.disabled = false;
        sendBtn.textContent = "Отправить USDT";
        return;
      }

      const tx = await usdtContract.transfer(to, amount);
      alert("Транзакция отправлена. Ожидание подтверждения...");

      await tx.wait();

      alert("USDT успешно отправлены!\nTx hash: " + tx.hash);

      await updateBalance();

    } catch (e) {
      alert("Ошибка отправки: " + e.message);
      console.error(e);
    } finally {
      sendBtn.disabled = false;
      sendBtn.textContent = "Отправить USDT";
    }
  };
</script>

</body>
</html>
