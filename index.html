<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Trust Wallet Transfer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
<script src="https://unpkg.com/@walletconnect/sign-client/dist/index.umd.js"></script>

<style>
body {
  background:#0e0e0e;
  color:#fff;
  font-family:Arial, sans-serif;
  max-width:500px;
  margin:40px auto;
  padding:20px;
}
button {
  width:100%;
  padding:14px;
  margin:10px 0;
  border-radius:10px;
  border:none;
  font-size:16px;
  cursor:pointer;
}
input {
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #333;
  background:#1a1a1a;
  color:#fff;
}
.primary {
  background:#3375bb;
  color:#fff;
}
.box {
  background:#1c1c1c;
  padding:15px;
  border-radius:12px;
  margin-top:20px;
}
hr {
  border:0;
  height:1px;
  background:#333;
  margin:15px 0;
}
</style>
</head>

<body>

<h2>üîµ Trust Wallet ‚Äî –ü–µ—Ä–µ–≤–æ–¥ BNB</h2>

<button class="primary" onclick="connectDapp()">üì± Trust Wallet (DApps)</button>
<button class="primary" onclick="connectWalletConnect()">üîó WalletConnect</button>

<div class="box" id="walletBox" style="display:none;">
  <p><b>–ê–¥—Ä–µ—Å:</b><br><span id="address"></span></p>
  <p><b>–ë–∞–ª–∞–Ω—Å:</b> <span id="balance"></span></p>

  <hr>

  <h3>üí∏ –ü–µ—Ä–µ–≤–æ–¥ BNB</h3>

  <input id="to" placeholder="–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è 0x..." />
  <input id="amount" type="number" step="0.0001" placeholder="–°—É–º–º–∞ BNB" />

  <button class="primary" onclick="sendBNB()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>

<script>
const PROJECT_ID = "6035d04bd27909e21d106b345131f578";

let provider;
let signer;
let userAddress;

/* ===== Trust Wallet DApps ===== */
async function connectDapp() {
  if (!window.ethereum) {
    alert("–û—Ç–∫—Ä–æ–π —Å–∞–π—Ç —á–µ—Ä–µ–∑ Trust Wallet ‚Üí DApps");
    return;
  }

  provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = await provider.getSigner();
  userAddress = await signer.getAddress();

  await showWallet();
}

/* ===== WalletConnect ===== */
async function connectWalletConnect() {
  if (location.protocol !== "https:" && location.hostname !== "localhost") {
    alert("WalletConnect —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ https –∏–ª–∏ localhost");
    return;
  }

  const signClient = await window.SignClient.init({
    projectId: PROJECT_ID,
    metadata: {
      name: "Trust Wallet Transfer",
      description: "Send BNB",
      url: window.location.origin,
      icons: []
    }
  });

  const { uri, approval } = await signClient.connect({
    requiredNamespaces: {
      eip155: {
        methods: ["eth_sendTransaction", "personal_sign"],
        chains: ["eip155:56"],
        events: []
      }
    }
  });

  window.open(
    "https://link.trustwallet.com/wc?uri=" + encodeURIComponent(uri),
    "_blank"
  );

  const session = await approval();
  userAddress = session.namespaces.eip155.accounts[0].split(":")[2];

  provider = new ethers.BrowserProvider({
    request: async ({ method, params }) => {
      return signClient.request({
        topic: session.topic,
        chainId: "eip155:56",
        request: { method, params }
      });
    }
  });

  signer = await provider.getSigner();
  await showWallet();
}

/* ===== UI ===== */
async function showWallet() {
  document.getElementById("walletBox").style.display = "block";
  document.getElementById("address").textContent = userAddress;

  const bal = await provider.getBalance(userAddress);
  document.getElementById("balance").textContent =
    ethers.formatEther(bal) + " BNB";
}

/* ===== SEND BNB ===== */
async function sendBNB() {
  const to = document.getElementById("to").value.trim();
  const amount = document.getElementById("amount").value;

  if (!ethers.isAddress(to)) {
    alert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è");
    return;
  }

  if (!amount || Number(amount) <= 0) {
    alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");
    return;
  }

  try {
    const value = ethers.parseEther(amount);
    const balance = await provider.getBalance(userAddress);

    if (balance < value) {
      alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ BNB");
      return;
    }

    const tx = await signer.sendTransaction({
      to: to,
      value: value,
      gasLimit: 21000n
    });

    alert("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ Trust Wallet");

    const receipt = await tx.wait();
    alert("‚úÖ –£—Å–ø–µ—à–Ω–æ!\nTX: " + receipt.hash);

    await showWallet();

  } catch (e) {
    console.error(e);

    if (e.code === 4001) {
      alert("–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º");
    } else {
      alert("–û—à–∏–±–∫–∞: " + (e.message || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
    }
  }
}
</script>

</body>
</html>
