<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>USDT BEP20 Transfer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
<script src="https://unpkg.com/@walletconnect/sign-client/dist/index.umd.js"></script>

<style>
body {
  background:#0e0e0e;
  color:#fff;
  font-family:Arial;
  max-width:500px;
  margin:40px auto;
  padding:20px;
}
button {
  width:100%;
  padding:14px;
  margin:10px 0;
  border-radius:10px;
  border:none;
  font-size:16px;
}
input {
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #333;
  background:#1a1a1a;
  color:#fff;
}
.primary { background:#26a17b; color:#fff; }
.box {
  background:#1c1c1c;
  padding:15px;
  border-radius:12px;
  margin-top:20px;
}
</style>
</head>

<body>

<h2>üí≤ USDT BEP-20 (Trust Wallet)</h2>

<button class="primary" onclick="connectDapp()">üì± Trust Wallet (DApps)</button>
<button class="primary" onclick="connectWalletConnect()">üîó WalletConnect</button>

<div class="box" id="wallet" style="display:none;">
  <p><b>–ê–¥—Ä–µ—Å:</b><br><span id="addr"></span></p>
  <p><b>USDT –±–∞–ª–∞–Ω—Å:</b> <span id="usdtBal"></span></p>

  <hr>

  <input id="to" placeholder="–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è 0x..." />
  <input id="amount" type="number" step="0.01" placeholder="–°—É–º–º–∞ USDT" />

  <button class="primary" onclick="sendUSDT()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å USDT</button>
</div>

<script>
const PROJECT_ID = "6035d04bd27909e21d106b345131f578";
const USDT_ADDRESS = "0x55d398326f99059fF775485246999027B3197955";

const USDT_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function transfer(address,uint256) returns (bool)",
  "function decimals() view returns (uint8)"
];

let provider, signer, userAddress, usdt;

/* ===== Trust Wallet DApps ===== */
async function connectDapp() {
  if (!window.ethereum) {
    alert("–û—Ç–∫—Ä–æ–π —Å–∞–π—Ç —á–µ—Ä–µ–∑ Trust Wallet ‚Üí DApps");
    return;
  }

  provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = await provider.getSigner();
  userAddress = await signer.getAddress();

  initUSDT();
}

/* ===== WalletConnect ===== */
async function connectWalletConnect() {
  if (location.protocol !== "https:" && location.hostname !== "localhost") {
    alert("WalletConnect —Ç—Ä–µ–±—É–µ—Ç https");
    return;
  }

  const signClient = await window.SignClient.init({
    projectId: PROJECT_ID,
    metadata: {
      name: "USDT Transfer",
      description: "Send USDT BEP20",
      url: window.location.origin,
      icons: []
    }
  });

  const { uri, approval } = await signClient.connect({
    requiredNamespaces: {
      eip155: {
        methods: ["eth_sendTransaction"],
        chains: ["eip155:56"],
        events: []
      }
    }
  });

  window.open(
    "https://link.trustwallet.com/wc?uri=" + encodeURIComponent(uri),
    "_blank"
  );

  const session = await approval();
  userAddress = session.namespaces.eip155.accounts[0].split(":")[2];

  provider = new ethers.BrowserProvider({
    request: async ({ method, params }) => {
      return signClient.request({
        topic: session.topic,
        chainId: "eip155:56",
        request: { method, params }
      });
    }
  });

  signer = await provider.getSigner();
  initUSDT();
}

/* ===== INIT USDT ===== */
async function initUSDT() {
  usdt = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);

  document.getElementById("wallet").style.display = "block";
  document.getElementById("addr").textContent = userAddress;

  await updateBalance();
}

async function updateBalance() {
  const decimals = await usdt.decimals();
  const bal = await usdt.balanceOf(userAddress);
  document.getElementById("usdtBal").textContent =
    ethers.formatUnits(bal, decimals) + " USDT";
}

/* ===== SEND USDT ===== */
async function sendUSDT() {
  const to = document.getElementById("to").value.trim();
  const amount = document.getElementById("amount").value;

  if (!ethers.isAddress(to)) {
    alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∞–¥—Ä–µ—Å");
    return;
  }

  if (!amount || Number(amount) <= 0) {
    alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");
    return;
  }

  try {
    const decimals = await usdt.decimals();
    const value = ethers.parseUnits(amount, decimals);
    const balance = await usdt.balanceOf(userAddress);

    if (balance < value) {
      alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ USDT");
      return;
    }

    const tx = await usdt.transfer(to, value, {
      gasLimit: 100000n
    });

    alert("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ Trust Wallet");

    await tx.wait();
    alert("‚úÖ USDT –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω");

    updateBalance();

  } catch (e) {
    console.error(e);
    if (e.code === 4001) {
      alert("–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞");
    } else {
      alert("–û—à–∏–±–∫–∞: " + (e.message || "unknown"));
    }
  }
}
</script>

</body>
</html>
