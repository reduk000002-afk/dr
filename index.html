<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Trust Wallet / WalletConnect</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ethers -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>

<!-- WalletConnect Sign Client -->
<script src="https://unpkg.com/@walletconnect/sign-client/dist/index.umd.js"></script>

<style>
body {
  background:#111;
  color:#fff;
  font-family:Arial;
  max-width:500px;
  margin:40px auto;
  padding:20px;
}
button {
  width:100%;
  padding:14px;
  margin:10px 0;
  border-radius:10px;
  border:none;
  font-size:16px;
  cursor:pointer;
}
.primary { background:#3375bb; color:#fff; }
.box {
  background:#1e1e1e;
  padding:15px;
  border-radius:10px;
  margin-top:20px;
}
</style>
</head>

<body>

<h2>üîµ Trust Wallet Connect</h2>

<button class="primary" onclick="connectDapp()">
üì± –ü–æ–¥–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ Trust Wallet (DApps)
</button>

<button class="primary" onclick="connectWalletConnect()">
üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ WalletConnect
</button>

<div class="box" id="info" style="display:none;">
  <p><b>–ê–¥—Ä–µ—Å:</b> <span id="addr"></span></p>
  <p><b>–ë–∞–ª–∞–Ω—Å:</b> <span id="bal"></span></p>
  <button onclick="signMsg()">‚úçÔ∏è –ü–æ–¥–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
</div>

<script>
const PROJECT_ID = "6035d04bd27909e21d106b345131f578";

let provider, signer, address;

/* =========================
   1Ô∏è‚É£ Trust Wallet DApp
========================= */
async function connectDapp() {
  if (!window.ethereum) {
    alert("–û—Ç–∫—Ä–æ–π —Å–∞–π—Ç —á–µ—Ä–µ–∑ Trust Wallet ‚Üí DApps");
    return;
  }

  provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = await provider.getSigner();
  address = await signer.getAddress();
  showInfo();
}

/* =========================
   2Ô∏è‚É£ WalletConnect v2
========================= */
async function connectWalletConnect() {

  if (location.protocol !== "https:" && location.hostname !== "localhost") {
    alert("WalletConnect —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ https –∏–ª–∏ localhost");
    return;
  }

  const signClient = await window.SignClient.init({
    projectId: PROJECT_ID,
    metadata: {
      name: "Trust Wallet Demo",
      description: "WalletConnect v2",
      url: window.location.origin,
      icons: []
    }
  });

  const { uri, approval } = await signClient.connect({
    requiredNamespaces: {
      eip155: {
        methods: ["eth_sendTransaction", "personal_sign"],
        chains: ["eip155:56"],
        events: ["accountsChanged","chainChanged"]
      }
    }
  });

  if (!uri) {
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å WalletConnect URI");
    return;
  }

  /* üëâ –û—Ç–∫—Ä—ã–≤–∞–µ–º Trust Wallet –Ω–∞–ø—Ä—è–º—É—é */
  const link = "https://link.trustwallet.com/wc?uri=" + encodeURIComponent(uri);
  window.open(link, "_blank");

  const session = await approval();

  const acc = session.namespaces.eip155.accounts[0];
  address = acc.split(":")[2];

  provider = new ethers.BrowserProvider({
    request: async ({ method, params }) => {
      return signClient.request({
        topic: session.topic,
        chainId: "eip155:56",
        request: { method, params }
      });
    }
  });

  signer = await provider.getSigner();
  showInfo();
}

/* =========================
   INFO
========================= */
async function showInfo() {
  document.getElementById("info").style.display = "block";
  document.getElementById("addr").textContent = address;

  const bal = await provider.getBalance(address);
  document.getElementById("bal").textContent =
    ethers.formatEther(bal) + " BNB";
}

/* =========================
   SIGN
========================= */
async function signMsg() {
  const msg = "Trust Wallet test " + Date.now();
  const sig = await signer.signMessage(msg);
  alert("–ü–æ–¥–ø–∏—Å—å:\n" + sig);
}
</script>

</body>
</html>
