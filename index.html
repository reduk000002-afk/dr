<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отправка USDT (BEP-20) через Trust Wallet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <!-- WalletConnect v1 для Trust Wallet -->
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #f1f5f9; min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; padding: 25px; background: rgba(30,41,59,0.7); border-radius: 20px; border: 1px solid rgba(100,116,139,0.3); }
        h1 { color: #3b82f6; font-size: 2.2rem; margin-bottom: 10px; }
        .card { background: rgba(30,41,59,0.8); border-radius: 15px; padding: 25px; margin-bottom: 20px; border: 1px solid rgba(100,116,139,0.3); }
        .status-card { display: flex; align-items: center; justify-content: space-between; gap: 20px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; background: #ef4444; }
        .status-indicator.connected { background: #10b981; box-shadow: 0 0 10px #10b981; }
        .btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(59,130,246,0.4); }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(16,185,129,0.4); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
        .btn-outline { background: transparent; border: 2px solid rgba(255,255,255,0.2); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        .wallet-details { margin: 20px 0; }
        .detail { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .detail:last-child { border-bottom: none; }
        .label { color: #94a3b8; font-weight: 500; }
        .value { color: #f1f5f9; font-weight: 600; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #e2e8f0; }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid rgba(100,116,139,0.5); background: rgba(15,23,42,0.7); color: white; font-size: 1rem; }
        input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .summary { background: rgba(15,23,42,0.7); padding: 15px; border-radius: 10px; margin: 20px 0; }
        .summary-item { display: flex; justify-content: space-between; padding: 8px 0; }
        .log-entry { padding: 10px; margin: 10px 0; border-radius: 10px; background: rgba(15,23,42,0.5); border-left: 4px solid #3b82f6; }
        .log-entry.success { border-left-color: #10b981; }
        .log-entry.error { border-left-color: #ef4444; }
        .log-entry.warning { border-left-color: #f59e0b; }
        .warning-box { background: rgba(245,158,11,0.1); border: 1px solid #f59e0b; padding: 15px; border-radius: 10px; margin-top: 20px; color: #fbbf24; }
        .info-box { background: rgba(59,130,246,0.1); border: 1px solid #3b82f6; padding: 15px; border-radius: 10px; margin-top: 20px; color: #93c5fd; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: rgba(30,41,59,0.95); border-radius: 20px; padding: 30px; width: 90%; max-width: 500px; border: 1px solid rgba(100,116,139,0.5); }
        .modal-step { text-align: center; padding: 30px 20px; display: none; }
        .modal-step.active { display: block; }
        .fa-spin { animation: fa-spin 2s infinite linear; }
        @keyframes fa-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .qr-container { text-align: center; padding: 20px; background: white; border-radius: 10px; margin: 20px 0; min-height: 250px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .token-balance { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(15,23,42,0.5); border-radius: 10px; margin: 10px 0; }
        @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } .status-card { flex-direction: column; text-align: center; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-coins"></i> Отправка USDT (BEP-20)</h1>
            <p class="subtitle">Подключите Trust Wallet и отправьте USDT в сети Binance Smart Chain</p>
        </header>

        <div class="card status-card">
            <div><div class="status-indicator" id="status-indicator"></div></div>
            <div class="status-text" style="flex: 1;">
                <span id="status-text" style="font-weight: 600;">Отключено</span>
                <small id="network-info" style="display: block; color: #94a3b8; margin-top: 5px;">Выберите сеть BSC</small>
            </div>
            <button id="connect-btn" class="btn btn-primary">
                <i class="fas fa-plug"></i> Подключить Trust Wallet
            </button>
        </div>

        <div class="card" id="wallet-card" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3><i class="fas fa-wallet"></i> Ваш кошелек</h3>
                <button id="copy-address" class="btn btn-secondary" style="padding: 8px 16px;">
                    <i class="far fa-copy"></i> Копировать адрес
                </button>
            </div>
            
            <div class="wallet-details">
                <div class="detail">
                    <span class="label">Адрес BSC:</span>
                    <span class="value" id="wallet-address">0x...</span>
                </div>
                <div class="detail">
                    <span class="label">Баланс BNB:</span>
                    <span class="value" id="wallet-balance">0 BNB</span>
                </div>
                <div class="token-balance">
                    <i class="fas fa-dollar-sign" style="color: #26a17b; font-size: 1.5rem;"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">USDT Balance</div>
                        <div id="usdt-balance" style="font-size: 1.2rem; font-weight: 700;">0 USDT</div>
                    </div>
                    <button id="refresh-usdt" class="btn btn-secondary" style="padding: 6px 12px;">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="detail">
                    <span class="label">Сеть:</span>
                    <span class="value" id="wallet-network">Не подключено</span>
                </div>
            </div>
            
            <button id="disconnect-btn" class="btn btn-outline" style="width: 100%; margin-top: 15px;">
                <i class="fas fa-sign-out-alt"></i> Отключиться
            </button>
        </div>

        <div class="card" id="send-card" style="display: none;">
            <h3 style="margin-bottom: 20px; color: #26a17b;">
                <i class="fas fa-paper-plane"></i> Отправить USDT (BEP-20)
            </h3>
            
            <div class="form-group">
                <label for="receiver-address">
                    <i class="fas fa-user-friends"></i> Адрес получателя (BSC):
                </label>
                <input type="text" id="receiver-address" placeholder="0x..." 
                       value="0x55d398326f99059fF775485246999027B3197955">
                <small style="color: #94a3b8; display: block; margin-top: 5px;">
                    Введите адрес кошелька BSC (начинается с 0x)
                </small>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="amount"><i class="fas fa-coins"></i> Количество USDT:</label>
                    <input type="number" id="amount" step="0.01" min="0.01" value="1.00" placeholder="1.00">
                </div>
                
                <div class="form-group">
                    <label for="network-select"><i class="fas fa-network-wired"></i> Сеть:</label>
                    <select id="network-select">
                        <option value="bsc">BSC Mainnet (реальная сеть)</option>
                        <option value="bsctest">BSC Testnet (тестовая)</option>
                    </select>
                </div>
            </div>
            
            <div class="summary">
                <h4 style="margin-bottom: 15px; color: #e2e8f0;">
                    <i class="fas fa-calculator"></i> Детали транзакции:
                </h4>
                <div class="summary-item">
                    <span>Сумма USDT:</span>
                    <span id="usdt-amount">1.00 USDT</span>
                </div>
                <div class="summary-item">
                    <span>Комиссия сети (BNB):</span>
                    <span id="gas-fee">~ 0.0012 BNB</span>
                </div>
                <div class="summary-item" style="font-weight: 700; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                    <span>Всего требуется BNB:</span>
                    <span id="total-bnb">0.0012 BNB</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button id="send-usdt-btn" class="btn btn-success" style="flex: 1;">
                    <i class="fas fa-paper-plane"></i> Отправить USDT
                </button>
                <button id="check-balance-btn" class="btn btn-secondary">
                    <i class="fas fa-sync-alt"></i> Проверить
                </button>
            </div>
        </div>

        <div class="card" id="log-card">
            <h3><i class="fas fa-history"></i> История операций</h3>
            <div class="log-entries" id="log-entries" style="max-height: 300px; overflow-y: auto; padding: 10px;">
                <div class="log-entry">
                    <i class="fas fa-info-circle"></i>
                    <span>Готов к работе. Подключите Trust Wallet для отправки USDT.</span>
                </div>
            </div>
        </div>

        <div class="card info-box">
            <h3><i class="fas fa-info-circle"></i> Важная информация:</h3>
            <p style="margin: 10px 0;">
                <strong>Адрес контракта USDT (BEP-20):</strong><br>
                <code style="background: rgba(0,0,0,0.3); padding: 5px; border-radius: 5px; font-size: 0.9rem;">
                    0x55d398326f99059fF775485246999027B3197955
                </code>
            </p>
            <p style="margin: 10px 0;">
                Для отправки USDT вам необходимо иметь небольшое количество BNB для оплаты комиссии (газа).
            </p>
        </div>

        <div class="card warning-box">
            <h3><i class="fas fa-exclamation-triangle"></i> Внимание!</h3>
            <p style="margin: 10px 0;">
                1. Убедитесь, что в Trust Wallet выбрана сеть <strong>Binance Smart Chain</strong><br>
                2. Для тестов используйте BSC Testnet и тестовые токены<br>
                3. Всегда проверяйте адрес получателя<br>
                4. Начинайте с небольших сумм для проверки
            </p>
        </div>
    </div>

    <!-- Модальное окно для QR кода -->
    <div class="modal" id="qr-modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #3b82f6;">
                    <i class="fas fa-qrcode"></i> Подключение к Trust Wallet
                </h3>
                <button onclick="closeQRModal()" style="background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer;">
                    &times;
                </button>
            </div>
            
            <div style="text-align: center;">
                <div id="qr-loading" style="padding: 20px;">
                    <i class="fas fa-spinner fa-spin fa-2x" style="color: #3b82f6;"></i>
                    <p style="margin-top: 10px;">Подготовка подключения...</p>
                </div>
                
                <div id="qr-content" style="display: none;">
                    <p>Отсканируйте QR-код в Trust Wallet:</p>
                    <div id="qr-image-container" class="qr-container">
                        <!-- QR код появится здесь -->
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button onclick="copyConnectionURI()" class="btn btn-primary">
                            <i class="fas fa-copy"></i> Копировать ссылку для подключения
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(15,23,42,0.5); border-radius: 10px;">
                        <h4>Как подключить:</h4>
                        <ol style="text-align: left; margin-left: 20px; margin-top: 10px;">
                            <li>Откройте <strong>Trust Wallet</strong> на телефоне</li>
                            <li>Нажмите на иконку <strong>⚙️ Настройки</strong></li>
                            <li>Выберите <strong>WalletConnect</strong></li>
                            <li>Нажмите <strong>"Новое соединение"</strong></li>
                            <li>Отсканируйте QR-код или нажмите "Вставить из буфера"</li>
                        </ol>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="connectWithBrowserWallet()" class="btn btn-secondary" style="width: 100%;">
                        <i class="fas fa-desktop"></i> Использовать браузерный кошелек (MetaMask)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно транзакции -->
    <div class="modal" id="tx-modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="modal-title" style="margin: 0; color: #3b82f6;">
                    <i class="fas fa-sync fa-spin"></i> Отправка USDT
                </h3>
                <button onclick="closeModal()" style="background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer;">
                    &times;
                </button>
            </div>
            
            <div class="modal-body">
                <div class="modal-step active" id="step-sign">
                    <i class="fas fa-file-signature fa-spin" style="color: #f59e0b;"></i>
                    <h4>Ожидание подписи...</h4>
                    <p>Подтвердите транзакцию в Trust Wallet</p>
                </div>
                
                <div class="modal-step" id="step-sending">
                    <i class="fas fa-paper-plane fa-spin" style="color: #3b82f6;"></i>
                    <h4>Отправка в сеть...</h4>
                    <p id="tx-hash-text" style="word-break: break-all; font-size: 0.9rem; margin-top: 10px;">
                        Хэш транзакции появится здесь
                    </p>
                </div>
                
                <div class="modal-step" id="step-success">
                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                    <h4>Успешно отправлено!</h4>
                    <p id="success-details" style="margin-top: 10px;"></p>
                    <a id="tx-explorer-link" href="#" target="_blank" 
                       style="display: inline-block; margin-top: 15px; color: #3b82f6; text-decoration: none;">
                       <i class="fas fa-external-link-alt"></i> Открыть в BscScan
                    </a>
                </div>
                
                <div class="modal-step" id="step-error">
                    <i class="fas fa-times-circle" style="color: #ef4444;"></i>
                    <h4>Ошибка</h4>
                    <p id="error-details" style="margin-top: 10px;"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Библиотека для QR-кодов (альтернативная) -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    
    <script>
        // ========== КОНФИГУРАЦИЯ ==========
        const WALLETCONNECT_PROJECT_ID = '6035d04bd27909e21d106b345131f578';
        
        // Адреса контрактов USDT
        const CONTRACT_ADDRESSES = {
            bsc: '0x55d398326f99059fF775485246999027B3197955', // USDT BEP-20 Mainnet
            bsctest: '0x337610d27c682E347C9cD60BD4b3b107C9d34dDd' // USDT BEP-20 Testnet
        };
        
        // ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
        let provider = null;
        let signer = null;
        let userAddress = null;
        let chainId = null;
        let usdtContract = null;
        let currentNetwork = 'bsc';
        let walletConnectProvider = null;
        let connectionURI = '';
        
        // ========== ЭЛЕМЕНТЫ DOM ==========
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const sendUsdtBtn = document.getElementById('send-usdt-btn');
        const checkBalanceBtn = document.getElementById('check-balance-btn');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const networkInfo = document.getElementById('network-info');
        const walletCard = document.getElementById('wallet-card');
        const sendCard = document.getElementById('send-card');
        const walletAddress = document.getElementById('wallet-address');
        const walletBalance = document.getElementById('wallet-balance');
        const usdtBalance = document.getElementById('usdt-balance');
        const walletNetwork = document.getElementById('wallet-network');
        const receiverAddress = document.getElementById('receiver-address');
        const amountInput = document.getElementById('amount');
        const networkSelect = document.getElementById('network-select');
        const logEntries = document.getElementById('log-entries');
        const txModal = document.getElementById('tx-modal');
        const qrModal = document.getElementById('qr-modal');
        const refreshUsdtBtn = document.getElementById('refresh-usdt');
        const qrLoading = document.getElementById('qr-loading');
        const qrContent = document.getElementById('qr-content');
        const qrImageContainer = document.getElementById('qr-image-container');
        
        // ========== ABI контракта USDT (BEP-20) ==========
        const USDT_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)",
            "function name() view returns (string)"
        ];
        
        // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
        function addLog(message, type = 'info') {
            const icon = {
                'success': 'check-circle',
                'error': 'times-circle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            }[type];
            
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${new Date().toLocaleTimeString()} - ${message}</span>
            `;
            logEntries.prepend(entry);
        }
        
        function updateUI(connected = false) {
            if (connected) {
                statusIndicator.className = 'status-indicator connected';
                statusText.textContent = 'Подключено';
                statusText.style.color = '#10b981';
                connectBtn.disabled = true;
                walletCard.style.display = 'block';
                sendCard.style.display = 'block';
                disconnectBtn.disabled = false;
                sendUsdtBtn.disabled = false;
                checkBalanceBtn.disabled = false;
            } else {
                statusIndicator.className = 'status-indicator';
                statusText.textContent = 'Отключено';
                statusText.style.color = '#f1f5f9';
                connectBtn.disabled = false;
                walletCard.style.display = 'none';
                sendCard.style.display = 'none';
                disconnectBtn.disabled = true;
                sendUsdtBtn.disabled = true;
                checkBalanceBtn.disabled = true;
            }
        }
        
        function showModalStep(stepId) {
            document.querySelectorAll('.modal-step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(stepId).classList.add('active');
        }
        
        function openModal() {
            txModal.style.display = 'flex';
        }
        
        function closeModal() {
            txModal.style.display = 'none';
        }
        
        function openQRModal() {
            qrModal.style.display = 'flex';
            qrLoading.style.display = 'block';
            qrContent.style.display = 'none';
            
            // Очищаем предыдущий QR-код
            qrImageContainer.innerHTML = '';
            
            // Создаем WalletConnect v1 провайдер
            createWalletConnectProvider();
        }
        
        function closeQRModal() {
            qrModal.style.display = 'none';
            if (walletConnectProvider) {
                walletConnectProvider.disconnect();
            }
        }
        
        function createWalletConnectProvider() {
            try {
                // Создаем WalletConnect v1 провайдер (поддерживается Trust Wallet)
                walletConnectProvider = new WalletConnectProvider.default({
                    infuraId: '27e484dcd9e3efcfd25a83a78777cdf1', // Бесплатный Infura ID
                    chainId: 56, // BSC Mainnet
                    qrcode: false // Не показываем QR автоматически
                });
                
                // Получаем URI для подключения
                walletConnectProvider.wc.createSession().then(() => {
                    connectionURI = walletConnectProvider.wc.uri;
                    
                    // Генерируем QR-код
                    generateQRCode(connectionURI);
                    
                    // Слушаем подключение
                    walletConnectProvider.wc.on("connect", (error, payload) => {
                        if (error) {
                            console.error('Ошибка подключения:', error);
                            return;
                        }
                        
                        // Подключение успешно
                        onWalletConnectConnected();
                    });
                    
                    qrLoading.style.display = 'none';
                    qrContent.style.display = 'block';
                    
                }).catch(error => {
                    console.error('Ошибка создания сессии:', error);
                    addLog('Ошибка создания подключения', 'error');
                    qrLoading.innerHTML = '<p style="color: #ef4444;">Ошибка. Попробуйте использовать браузерный кошелек.</p>';
                });
                
            } catch (error) {
                console.error('Ошибка создания провайдера:', error);
                addLog('Ошибка инициализации WalletConnect', 'error');
                qrLoading.innerHTML = '<p style="color: #ef4444;">Ошибка. Используйте браузерный кошелек.</p>';
            }
        }
        
        function generateQRCode(text) {
            try {
                // Используем qrcode-generator библиотеку
                const typeNumber = 0; // Авто
                const errorCorrectionLevel = 'L';
                const qr = qrcode(typeNumber, errorCorrectionLevel);
                qr.addData(text);
                qr.make();
                
                // Создаем изображение QR-кода
                const qrSize = 200;
                const cellSize = qrSize / qr.getModuleCount();
                
                const canvas = document.createElement('canvas');
                canvas.width = qrSize;
                canvas.height = qrSize;
                const ctx = canvas.getContext('2d');
                
                // Очищаем canvas
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, qrSize, qrSize);
                
                // Рисуем QR-код
                ctx.fillStyle = '#000000';
                for (let row = 0; row < qr.getModuleCount(); row++) {
                    for (let col = 0; col < qr.getModuleCount(); col++) {
                        if (qr.isDark(row, col)) {
                            ctx.fillRect(
                                col * cellSize,
                                row * cellSize,
                                cellSize,
                                cellSize
                            );
                        }
                    }
                }
                
                qrImageContainer.innerHTML = '';
                qrImageContainer.appendChild(canvas);
                
            } catch (error) {
                console.error('Ошибка генерации QR-кода:', error);
                // Альтернатива: показываем текст
                qrImageContainer.innerHTML = `
                    <div style="color: black; padding: 20px; text-align: center;">
                        <p><strong>Ссылка для подключения:</strong></p>
                        <p style="font-size: 0.7rem; word-break: break-all; background: #f0f0f0; padding: 10px; border-radius: 5px;">
                            ${text.substring(0, 60)}...
                        </p>
                        <p><small>Скопируйте эту ссылку в Trust Wallet</small></p>
                    </div>
                `;
            }
        }
        
        function copyConnectionURI() {
            if (connectionURI) {
                navigator.clipboard.writeText(connectionURI)
                    .then(() => {
                        addLog('Ссылка скопирована в буфер обмена', 'success');
                        alert('Ссылка скопирована! Вставьте её в Trust Wallet → WalletConnect → "Вставить из буфера"');
                    })
                    .catch(err => {
                        console.error('Ошибка копирования:', err);
                        addLog('Не удалось скопировать ссылку', 'error');
                    });
            }
        }
        
        async function onWalletConnectConnected() {
            try {
                // Устанавливаем провайдер
                provider = new ethers.BrowserProvider(walletConnectProvider);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                const network = await provider.getNetwork();
                chainId = Number(network.chainId);
                
                await updateWalletInfo();
                updateUI(true);
                initUsdtContract();
                closeQRModal();
                
                addLog(`Trust Wallet подключен: ${userAddress.substring(0, 6)}...`, 'success');
                
            } catch (error) {
                console.error('Ошибка после подключения:', error);
                addLog(`Ошибка: ${error.message}`, 'error');
            }
        }
        
        async function getNetworkName(chainId) {
            const networks = {
                1: 'Ethereum Mainnet',
                56: 'BNB Smart Chain',
                97: 'BNB Testnet',
                11155111: 'Sepolia',
                5: 'Goerli'
            };
            return networks[chainId] || `Сеть ${chainId}`;
        }
        
        // ========== ПОДКЛЮЧЕНИЕ КОШЕЛЬКА ==========
        async function connectWallet() {
            try {
                addLog('Подключение кошелька...', 'info');
                openQRModal();
                
            } catch (error) {
                console.error('Ошибка подключения:', error);
                addLog(`Ошибка: ${error.message}`, 'error');
            }
        }
        
        // Подключение через браузерный кошелек (MetaMask/Trust Wallet в браузере)
        async function connectWithBrowserWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    addLog('Браузерный кошелек не найден', 'error');
                    alert('Установите MetaMask или Trust Wallet расширение для браузера');
                    return;
                }
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                userAddress = accounts[0];
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                
                const network = await provider.getNetwork();
                chainId = Number(network.chainId);
                
                await updateWalletInfo();
                updateUI(true);
                initUsdtContract();
                closeQRModal();
                
                addLog(`Кошелек подключен: ${userAddress.substring(0, 6)}...`, 'success');
                
                // Слушаем события
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        disconnectWallet();
                    } else {
                        userAddress = accounts[0];
                        updateWalletInfo();
                    }
                });
                
                window.ethereum.on('chainChanged', () => {
                    window.location.reload();
                });
                
            } catch (error) {
                addLog(`Ошибка подключения: ${error.message}`, 'error');
                alert('Ошибка подключения: ' + error.message);
            }
        }
        
        async function updateWalletInfo() {
            try {
                if (!userAddress || !provider) return;
                
                // Адрес
                const shortAddress = `${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                walletAddress.textContent = shortAddress;
                
                // Сеть
                const networkName = await getNetworkName(chainId);
                walletNetwork.textContent = networkName;
                networkInfo.textContent = networkName;
                
                // Баланс BNB
                const balance = await provider.getBalance(userAddress);
                const balanceInBnb = ethers.formatEther(balance);
                walletBalance.textContent = `${parseFloat(balanceInBnb).toFixed(6)} BNB`;
                
                // Баланс USDT если контракт инициализирован
                if (usdtContract) {
                    await checkUsdtBalance();
                }
                
            } catch (error) {
                console.error('Ошибка обновления информации:', error);
            }
        }
        
        function disconnectWallet() {
            if (walletConnectProvider) {
                walletConnectProvider.disconnect();
            }
            provider = null;
            signer = null;
            userAddress = null;
            usdtContract = null;
            updateUI(false);
            addLog('Кошелек отключен', 'info');
        }
        
        // ========== РАБОТА С USDT ==========
        function initUsdtContract() {
            try {
                const contractAddress = CONTRACT_ADDRESSES[currentNetwork];
                usdtContract = new ethers.Contract(contractAddress, USDT_ABI, signer);
                addLog(`Контракт USDT загружен`, 'success');
                checkUsdtBalance();
            } catch (error) {
                console.error('Ошибка инициализации контракта:', error);
                addLog('Ошибка загрузки контракта USDT', 'error');
            }
        }
        
        async function checkUsdtBalance() {
            try {
                if (!usdtContract || !userAddress) return;
                
                const balance = await usdtContract.balanceOf(userAddress);
                const decimals = await usdtContract.decimals();
                const balanceFormatted = ethers.formatUnits(balance, decimals);
                
                usdtBalance.textContent = `${parseFloat(balanceFormatted).toFixed(2)} USDT`;
                addLog(`Баланс USDT: ${parseFloat(balanceFormatted).toFixed(2)} USDT`, 'info');
                
            } catch (error) {
                console.error('Ошибка проверки баланса USDT:', error);
                usdtBalance.textContent = 'Ошибка загрузки';
            }
        }
        
        async function sendUsdt() {
            if (!signer || !usdtContract) {
                addLog('Сначала подключите кошелек', 'error');
                return;
            }
            
            const to = receiverAddress.value.trim();
            const amount = amountInput.value;
            
            // Валидация
            if (!to || !to.startsWith('0x') || to.length !== 42) {
                addLog('Некорректный адрес получателя', 'error');
                return;
            }
            
            if (!amount || parseFloat(amount) <= 0) {
                addLog('Введите корректную сумму', 'error');
                return;
            }
            
            try {
                openModal();
                showModalStep('step-sign');
                
                addLog(`Начало отправки ${amount} USDT...`, 'info');
                
                // Получаем decimals контракта
                const decimals = await usdtContract.decimals();
                const amountInWei = ethers.parseUnits(amount, decimals);
                
                // Отправляем транзакцию
                const tx = await usdtContract.transfer(to, amountInWei);
                addLog(`Транзакция подписана`, 'info');
                
                showModalStep('step-sending');
                document.getElementById('tx-hash-text').textContent = `Хэш: ${tx.hash.substring(0, 30)}...`;
                
                // Ждем подтверждения
                const receipt = await tx.wait();
                
                // Успех!
                showModalStep('step-success');
                document.getElementById('success-details').textContent = 
                    `Успешно отправлено ${amount} USDT`;
                
                // Ссылка на BscScan
                const explorerLink = currentNetwork === 'bsc' 
                    ? `https://bscscan.com/tx/${tx.hash}`
                    : `https://testnet.bscscan.com/tx/${tx.hash}`;
                
                document.getElementById('tx-explorer-link').href = explorerLink;
                
                addLog(`✅ Успешно отправлено ${amount} USDT!`, 'success');
                
                // Обновляем балансы
                await updateWalletInfo();
                
                // Автозакрытие через 8 секунд
                setTimeout(closeModal, 8000);
                
            } catch (error) {
                console.error('Ошибка отправки USDT:', error);
                
                showModalStep('step-error');
                let errorMsg = error.message || 'Неизвестная ошибка';
                
                // Упрощаем сообщение
                if (errorMsg.includes('user rejected')) {
                    errorMsg = 'Транзакция отклонена в кошельке';
                } else if (errorMsg.includes('insufficient funds')) {
                    errorMsg = 'Недостаточно BNB для комиссии';
                } else if (errorMsg.includes('insufficient balance')) {
                    errorMsg = 'Недостаточно USDT на балансе';
                }
                
                document.getElementById('error-details').textContent = errorMsg;
                addLog(`❌ Ошибка: ${errorMsg}`, 'error');
            }
        }
        
        // ========== ИНИЦИАЛИЗАЦИЯ ==========
        document.getElementById('connect-btn').addEventListener('click', connectWallet);
        document.getElementById('disconnect-btn').addEventListener('click', disconnectWallet);
        document.getElementById('send-usdt-btn').addEventListener('click', sendUsdt);
        document.getElementById('check-balance-btn').addEventListener('click', () => {
            checkUsdtBalance();
            addLog('Проверка баланса...', 'info');
        });
        
        document.getElementById('refresh-usdt').addEventListener('click', checkUsdtBalance);
        
        // Копирование адреса
        document.getElementById('copy-address').addEventListener('click', () => {
            if (userAddress) {
                navigator.clipboard.writeText(userAddress);
                addLog('Адрес скопирован в буфер обмена', 'success');
            }
        });
        
        // Обновление сводки
        amountInput.addEventListener('input', () => {
            document.getElementById('usdt-amount').textContent = `${amountInput.value} USDT`;
        });
        
        networkSelect.addEventListener('change', (e) => {
            currentNetwork = e.target.value;
            if (usdtContract) {
                initUsdtContract();
            }
        });
        
        // При загрузке страницы
        window.addEventListener('load', async () => {
            if (window.ethereum && window.ethereum.selectedAddress) {
                try {
                    addLog('Автоподключение...', 'info');
                    provider = new ethers.BrowserProvider(window.ethereum);
                    userAddress = window.ethereum.selectedAddress;
                    signer = await provider.getSigner();
                    const network = await provider.getNetwork();
                    chainId = Number(network.chainId);
                    
                    await updateWalletInfo();
                    updateUI(true);
                    initUsdtContract();
                    addLog('Автоподключение успешно', 'success');
                } catch (error) {
                    console.error('Ошибка автоподключения:', error);
                }
            }
            
            document.getElementById('usdt-amount').textContent = `${amountInput.value} USDT`;
        });
    </script>
</body>
</html>
