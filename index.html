<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отправка USDT (BEP-20) через Trust Wallet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #f1f5f9; min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; padding: 25px; background: rgba(30,41,59,0.7); border-radius: 20px; border: 1px solid rgba(100,116,139,0.3); }
        h1 { color: #3b82f6; font-size: 2.2rem; margin-bottom: 10px; }
        .card { background: rgba(30,41,59,0.8); border-radius: 15px; padding: 25px; margin-bottom: 20px; border: 1px solid rgba(100,116,139,0.3); }
        .status-card { display: flex; align-items: center; justify-content: space-between; gap: 20px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; background: #ef4444; }
        .status-indicator.connected { background: #10b981; box-shadow: 0 0 10px #10b981; }
        .btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(59,130,246,0.4); }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(16,185,129,0.4); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
        .btn-outline { background: transparent; border: 2px solid rgba(255,255,255,0.2); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        .wallet-details { margin: 20px 0; }
        .detail { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .detail:last-child { border-bottom: none; }
        .label { color: #94a3b8; font-weight: 500; }
        .value { color: #f1f5f9; font-weight: 600; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #e2e8f0; }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid rgba(100,116,139,0.5); background: rgba(15,23,42,0.7); color: white; font-size: 1rem; }
        input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .summary { background: rgba(15,23,42,0.7); padding: 15px; border-radius: 10px; margin: 20px 0; }
        .summary-item { display: flex; justify-content: space-between; padding: 8px 0; }
        .log-entry { padding: 10px; margin: 10px 0; border-radius: 10px; background: rgba(15,23,42,0.5); border-left: 4px solid #3b82f6; }
        .log-entry.success { border-left-color: #10b981; }
        .log-entry.error { border-left-color: #ef4444; }
        .log-entry.warning { border-left-color: #f59e0b; }
        .warning-box { background: rgba(245,158,11,0.1); border: 1px solid #f59e0b; padding: 15px; border-radius: 10px; margin-top: 20px; color: #fbbf24; }
        .info-box { background: rgba(59,130,246,0.1); border: 1px solid #3b82f6; padding: 15px; border-radius: 10px; margin-top: 20px; color: #93c5fd; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: rgba(30,41,59,0.95); border-radius: 20px; padding: 30px; width: 90%; max-width: 500px; border: 1px solid rgba(100,116,139,0.5); }
        .modal-step { text-align: center; padding: 30px 20px; display: none; }
        .modal-step.active { display: block; }
        .fa-spin { animation: fa-spin 2s infinite linear; }
        @keyframes fa-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .token-balance { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(15,23,42,0.5); border-radius: 10px; margin: 10px 0; }
        .instruction-box { background: rgba(59,130,246,0.1); border: 1px solid #3b82f6; padding: 20px; border-radius: 10px; margin: 20px 0; }
        @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } .status-card { flex-direction: column; text-align: center; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-coins"></i> Отправка USDT (BEP-20)</h1>
            <p class="subtitle">Подключите Trust Wallet и отправьте USDT в сети Binance Smart Chain</p>
        </header>

        <div class="card instruction-box">
            <h3><i class="fas fa-graduation-cap"></i> Как подключить Trust Wallet:</h3>
            <ol style="margin-left: 20px; margin-top: 10px;">
                <li><strong>Откройте этот сайт в браузере Trust Wallet</strong> на телефоне</li>
                <li><strong>Нажмите "Подключить Trust Wallet"</strong> ниже</li>
                <li><strong>Подтвердите подключение</strong> в Trust Wallet</li>
                <li>Или используйте <strong>MetaMask</strong> на компьютере</li>
            </ol>
        </div>

        <div class="card status-card">
            <div><div class="status-indicator" id="status-indicator"></div></div>
            <div class="status-text" style="flex: 1;">
                <span id="status-text" style="font-weight: 600;">Отключено</span>
                <small id="network-info" style="display: block; color: #94a3b8; margin-top: 5px;">Выберите сеть BSC</small>
            </div>
            <button id="connect-btn" class="btn btn-primary">
                <i class="fas fa-plug"></i> Подключить Trust Wallet
            </button>
        </div>

        <div class="card" id="wallet-card" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3><i class="fas fa-wallet"></i> Ваш кошелек</h3>
                <button id="copy-address" class="btn btn-secondary" style="padding: 8px 16px;">
                    <i class="far fa-copy"></i> Копировать адрес
                </button>
            </div>
            
            <div class="wallet-details">
                <div class="detail">
                    <span class="label">Адрес BSC:</span>
                    <span class="value" id="wallet-address">0x...</span>
                </div>
                <div class="detail">
                    <span class="label">Баланс BNB:</span>
                    <span class="value" id="wallet-balance">0 BNB</span>
                </div>
                <div class="token-balance">
                    <i class="fas fa-dollar-sign" style="color: #26a17b; font-size: 1.5rem;"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">USDT Balance</div>
                        <div id="usdt-balance" style="font-size: 1.2rem; font-weight: 700;">0 USDT</div>
                    </div>
                    <button id="refresh-usdt" class="btn btn-secondary" style="padding: 6px 12px;">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="detail">
                    <span class="label">Сеть:</span>
                    <span class="value" id="wallet-network">Не подключено</span>
                </div>
            </div>
            
            <button id="disconnect-btn" class="btn btn-outline" style="width: 100%; margin-top: 15px;">
                <i class="fas fa-sign-out-alt"></i> Отключиться
            </button>
        </div>

        <div class="card" id="send-card" style="display: none;">
            <h3 style="margin-bottom: 20px; color: #26a17b;">
                <i class="fas fa-paper-plane"></i> Отправить USDT (BEP-20)
            </h3>
            
            <div class="form-group">
                <label for="receiver-address">
                    <i class="fas fa-user-friends"></i> Адрес получателя (BSC):
                </label>
                <input type="text" id="receiver-address" placeholder="0x..." 
                       value="0x55d398326f99059fF775485246999027B3197955">
                <small style="color: #94a3b8; display: block; margin-top: 5px;">
                    Введите адрес кошелька BSC (начинается с 0x)
                </small>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="amount"><i class="fas fa-coins"></i> Количество USDT:</label>
                    <input type="number" id="amount" step="0.01" min="0.01" value="1.00" placeholder="1.00">
                </div>
                
                <div class="form-group">
                    <label for="network-select"><i class="fas fa-network-wired"></i> Сеть:</label>
                    <select id="network-select">
                        <option value="bsc">BSC Mainnet (реальная сеть)</option>
                        <option value="bsctest">BSC Testnet (тестовая)</option>
                    </select>
                </div>
            </div>
            
            <div class="summary">
                <h4 style="margin-bottom: 15px; color: #e2e8f0;">
                    <i class="fas fa-calculator"></i> Детали транзакции:
                </h4>
                <div class="summary-item">
                    <span>Сумма USDT:</span>
                    <span id="usdt-amount">1.00 USDT</span>
                </div>
                <div class="summary-item">
                    <span>Комиссия сети (BNB):</span>
                    <span id="gas-fee">~ 0.0012 BNB</span>
                </div>
                <div class="summary-item" style="font-weight: 700; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                    <span>Всего требуется BNB:</span>
                    <span id="total-bnb">0.0012 BNB</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button id="send-usdt-btn" class="btn btn-success" style="flex: 1;">
                    <i class="fas fa-paper-plane"></i> Отправить USDT
                </button>
                <button id="check-balance-btn" class="btn btn-secondary">
                    <i class="fas fa-sync-alt"></i> Проверить
                </button>
            </div>
        </div>

        <div class="card" id="log-card">
            <h3><i class="fas fa-history"></i> История операций</h3>
            <div class="log-entries" id="log-entries" style="max-height: 300px; overflow-y: auto; padding: 10px;">
                <div class="log-entry">
                    <i class="fas fa-info-circle"></i>
                    <span>Готов к работе. Подключите Trust Wallet для отправки USDT.</span>
                </div>
            </div>
        </div>

        <div class="card info-box">
            <h3><i class="fas fa-info-circle"></i> Важная информация:</h3>
            <p style="margin: 10px 0;">
                <strong>Адрес контракта USDT (BEP-20):</strong><br>
                <code style="background: rgba(0,0,0,0.3); padding: 5px; border-radius: 5px; font-size: 0.9rem;">
                    0x55d398326f99059fF775485246999027B3197955
                </code>
            </p>
            <p style="margin: 10px 0;">
                Для отправки USDT вам необходимо иметь небольшое количество BNB для оплаты комиссии (газа).
            </p>
        </div>

        <div class="card warning-box">
            <h3><i class="fas fa-exclamation-triangle"></i> Внимание!</h3>
            <p style="margin: 10px 0;">
                1. Убедитесь, что в Trust Wallet выбрана сеть <strong>Binance Smart Chain</strong><br>
                2. Для тестов используйте BSC Testnet и тестовые токены<br>
                3. Всегда проверяйте адрес получателя<br>
                4. Начинайте с небольших сумм для проверки<br>
                5. <strong>Открывайте сайт прямо в браузере Trust Wallet!</strong>
            </p>
        </div>
    </div>

    <!-- Модальное окно транзакции -->
    <div class="modal" id="tx-modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="modal-title" style="margin: 0; color: #3b82f6;">
                    <i class="fas fa-sync fa-spin"></i> Отправка USDT
                </h3>
                <button onclick="closeModal()" style="background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer;">
                    &times;
                </button>
            </div>
            
            <div class="modal-body">
                <div class="modal-step active" id="step-sign">
                    <i class="fas fa-file-signature fa-spin" style="color: #f59e0b;"></i>
                    <h4>Ожидание подписи...</h4>
                    <p>Подтвердите транзакцию в Trust Wallet</p>
                </div>
                
                <div class="modal-step" id="step-sending">
                    <i class="fas fa-paper-plane fa-spin" style="color: #3b82f6;"></i>
                    <h4>Отправка в сеть...</h4>
                    <p id="tx-hash-text" style="word-break: break-all; font-size: 0.9rem; margin-top: 10px;">
                        Хэш транзакции появится здесь
                    </p>
                </div>
                
                <div class="modal-step" id="step-success">
                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                    <h4>Успешно отправлено!</h4>
                    <p id="success-details" style="margin-top: 10px;"></p>
                    <a id="tx-explorer-link" href="#" target="_blank" 
                       style="display: inline-block; margin-top: 15px; color: #3b82f6; text-decoration: none;">
                       <i class="fas fa-external-link-alt"></i> Открыть в BscScan
                    </a>
                </div>
                
                <div class="modal-step" id="step-error">
                    <i class="fas fa-times-circle" style="color: #ef4444;"></i>
                    <h4>Ошибка</h4>
                    <p id="error-details" style="margin-top: 10px;"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== КОНФИГУРАЦИЯ ==========
        const WALLETCONNECT_PROJECT_ID = '6035d04bd27909e21d106b345131f578';
        
        // Адреса контрактов USDT
        const CONTRACT_ADDRESSES = {
            bsc: '0x55d398326f99059fF775485246999027B3197955', // USDT BEP-20 Mainnet
            bsctest: '0x337610d27c682E347C9cD60BD4b3b107C9d34dDd' // USDT BEP-20 Testnet
        };
        
        // ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
        let provider = null;
        let signer = null;
        let userAddress = null;
        let chainId = null;
        let usdtContract = null;
        let currentNetwork = 'bsc';
        
        // ========== ЭЛЕМЕНТЫ DOM ==========
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const sendUsdtBtn = document.getElementById('send-usdt-btn');
        const checkBalanceBtn = document.getElementById('check-balance-btn');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const networkInfo = document.getElementById('network-info');
        const walletCard = document.getElementById('wallet-card');
        const sendCard = document.getElementById('send-card');
        const walletAddress = document.getElementById('wallet-address');
        const walletBalance = document.getElementById('wallet-balance');
        const usdtBalance = document.getElementById('usdt-balance');
        const walletNetwork = document.getElementById('wallet-network');
        const receiverAddress = document.getElementById('receiver-address');
        const amountInput = document.getElementById('amount');
        const networkSelect = document.getElementById('network-select');
        const logEntries = document.getElementById('log-entries');
        const txModal = document.getElementById('tx-modal');
        const refreshUsdtBtn = document.getElementById('refresh-usdt');
        
        // ========== ABI контракта USDT (BEP-20) ==========
        const USDT_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)",
            "function name() view returns (string)"
        ];
        
        // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
        function addLog(message, type = 'info') {
            const icon = {
                'success': 'check-circle',
                'error': 'times-circle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            }[type];
            
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${new Date().toLocaleTimeString()} - ${message}</span>
            `;
            logEntries.prepend(entry);
        }
        
        function updateUI(connected = false) {
            if (connected) {
                statusIndicator.className = 'status-indicator connected';
                statusText.textContent = 'Подключено';
                statusText.style.color = '#10b981';
                connectBtn.disabled = true;
                walletCard.style.display = 'block';
                sendCard.style.display = 'block';
                disconnectBtn.disabled = false;
                sendUsdtBtn.disabled = false;
                checkBalanceBtn.disabled = false;
            } else {
                statusIndicator.className = 'status-indicator';
                statusText.textContent = 'Отключено';
                statusText.style.color = '#f1f5f9';
                connectBtn.disabled = false;
                walletCard.style.display = 'none';
                sendCard.style.display = 'none';
                disconnectBtn.disabled = true;
                sendUsdtBtn.disabled = true;
                checkBalanceBtn.disabled = true;
            }
        }
        
        function showModalStep(stepId) {
            document.querySelectorAll('.modal-step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(stepId).classList.add('active');
        }
        
        function openModal() {
            txModal.style.display = 'flex';
        }
        
        function closeModal() {
            txModal.style.display = 'none';
        }
        
        async function getNetworkName(chainId) {
            const networks = {
                1: 'Ethereum Mainnet',
                56: 'BNB Smart Chain',
                97: 'BNB Testnet',
                11155111: 'Sepolia',
                5: 'Goerli'
            };
            return networks[chainId] || `Сеть ${chainId}`;
        }
        
        // ========== ПРОСТОЕ ПОДКЛЮЧЕНИЕ КОШЕЛЬКА ==========
        async function connectWallet() {
            try {
                addLog('Попытка подключения кошелька...', 'info');
                
                // Проверяем, есть ли браузерный кошелек
                if (typeof window.ethereum === 'undefined') {
                    addLog('Кошелек не найден!', 'error');
                    alert(
                        'Trust Wallet или MetaMask не найден!\n\n' +
                        'На телефоне: Откройте этот сайт в браузере Trust Wallet\n' +
                        'На компьютере: Установите MetaMask расширение'
                    );
                    return;
                }
                
                // Запрашиваем доступ к аккаунтам
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (accounts.length === 0) {
                    addLog('Пользователь отклонил запрос', 'warning');
                    return;
                }
                
                userAddress = accounts[0];
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                
                // Получаем информацию о сети
                const network = await provider.getNetwork();
                chainId = Number(network.chainId);
                
                // Проверяем, что сеть BSC (56) или BSC Testnet (97)
                if (chainId !== 56 && chainId !== 97) {
                    addLog(`Неверная сеть! Переключитесь на BSC (ID: 56) или BSC Testnet (ID: 97)`, 'warning');
                    alert(
                        `Текущая сеть: ${await getNetworkName(chainId)}\n\n` +
                        'Переключитесь в Trust Wallet на сеть:\n' +
                        '• BSC Mainnet (ID: 56) для реальных транзакций\n' +
                        '• BSC Testnet (ID: 97) для тестов'
                    );
                    
                    try {
                        // Пробуем переключить сеть на BSC
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x38' }], // 56 в hex
                        });
                        // Перезагружаем страницу после смены сети
                        setTimeout(() => location.reload(), 1000);
                    } catch (switchError) {
                        console.error('Ошибка переключения сети:', switchError);
                    }
                    return;
                }
                
                // Обновляем интерфейс
                await updateWalletInfo();
                updateUI(true);
                initUsdtContract();
                
                addLog(`Кошелек подключен: ${userAddress.substring(0, 6)}...`, 'success');
                
                // Слушаем события изменения аккаунта
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        disconnectWallet();
                    } else {
                        userAddress = accounts[0];
                        updateWalletInfo();
                        initUsdtContract();
                    }
                });
                
                // Слушаем события изменения сети
                window.ethereum.on('chainChanged', () => {
                    location.reload();
                });
                
            } catch (error) {
                console.error('Ошибка подключения:', error);
                
                let errorMessage = 'Неизвестная ошибка';
                
                if (error.code === 4001) {
                    errorMessage = 'Пользователь отклонил запрос на подключение';
                } else if (error.code === -32002) {
                    errorMessage = 'Запрос на подключение уже ожидает подтверждения';
                } else {
                    errorMessage = error.message || error.toString();
                }
                
                addLog(`Ошибка подключения: ${errorMessage}`, 'error');
                alert(`Ошибка подключения: ${errorMessage}`);
            }
        }
        
        async function updateWalletInfo() {
            try {
                if (!userAddress || !provider) return;
                
                // Адрес
                const shortAddress = `${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                walletAddress.textContent = shortAddress;
                
                // Сеть
                const networkName = await getNetworkName(chainId);
                walletNetwork.textContent = networkName;
                networkInfo.textContent = networkName;
                
                // Баланс BNB
                const balance = await provider.getBalance(userAddress);
                const balanceInBnb = ethers.formatEther(balance);
                walletBalance.textContent = `${parseFloat(balanceInBnb).toFixed(6)} BNB`;
                
                // Баланс USDT если контракт инициализирован
                if (usdtContract) {
                    await checkUsdtBalance();
                }
                
            } catch (error) {
                console.error('Ошибка обновления информации:', error);
                addLog(`Ошибка обновления данных: ${error.message}`, 'error');
            }
        }
        
        function disconnectWallet() {
            provider = null;
            signer = null;
            userAddress = null;
            usdtContract = null;
            updateUI(false);
            addLog('Кошелек отключен', 'info');
        }
        
        // ========== РАБОТА С USDT ==========
        function initUsdtContract() {
            try {
                // Определяем сеть и адрес контракта
                const networkId = chainId === 97 ? 'bsctest' : 'bsc';
                currentNetwork = networkId;
                networkSelect.value = networkId;
                
                const contractAddress = CONTRACT_ADDRESSES[networkId];
                usdtContract = new ethers.Contract(contractAddress, USDT_ABI, signer);
                
                addLog(`Контракт USDT загружен (${networkId})`, 'success');
                checkUsdtBalance();
                
            } catch (error) {
                console.error('Ошибка инициализации контракта:', error);
                addLog('Ошибка загрузки контракта USDT', 'error');
            }
        }
        
        async function checkUsdtBalance() {
            try {
                if (!usdtContract || !userAddress) return;
                
                const balance = await usdtContract.balanceOf(userAddress);
                const decimals = await usdtContract.decimals();
                const balanceFormatted = ethers.formatUnits(balance, decimals);
                
                usdtBalance.textContent = `${parseFloat(balanceFormatted).toFixed(2)} USDT`;
                addLog(`Баланс USDT обновлен: ${parseFloat(balanceFormatted).toFixed(2)} USDT`, 'info');
                
            } catch (error) {
                console.error('Ошибка проверки баланса USDT:', error);
                usdtBalance.textContent = 'Ошибка загрузки';
                addLog('Ошибка получения баланса USDT', 'error');
            }
        }
        
        async function sendUsdt() {
            if (!signer || !usdtContract) {
                addLog('Сначала подключите кошелек', 'error');
                return;
            }
            
            const to = receiverAddress.value.trim();
            const amount = amountInput.value;
            
            // Валидация
            if (!to || !to.startsWith('0x') || to.length !== 42) {
                addLog('Некорректный адрес получателя', 'error');
                alert('Введите корректный адрес кошелька BSC (начинается с 0x, 42 символа)');
                return;
            }
            
            if (!amount || parseFloat(amount) <= 0) {
                addLog('Введите корректную сумму', 'error');
                alert('Введите положительное количество USDT');
                return;
            }
            
            try {
                openModal();
                showModalStep('step-sign');
                
                addLog(`Начало отправки ${amount} USDT на адрес ${to.substring(0, 10)}...`, 'info');
                
                // Получаем decimals контракта
                const decimals = await usdtContract.decimals();
                const amountInWei = ethers.parseUnits(amount, decimals);
                
                // Отправляем транзакцию
                const tx = await usdtContract.transfer(to, amountInWei);
                addLog(`Транзакция подписана. Хэш: ${tx.hash.substring(0, 20)}...`, 'info');
                
                showModalStep('step-sending');
                document.getElementById('tx-hash-text').textContent = `Хэш: ${tx.hash}`;
                
                // Ждем подтверждения
                addLog('Ожидание подтверждения транзакции...', 'info');
                const receipt = await tx.wait();
                
                // Успех!
                showModalStep('step-success');
                document.getElementById('success-details').textContent = 
                    `Успешно отправлено ${amount} USDT`;
                
                // Ссылка на BscScan
                const explorerLink = currentNetwork === 'bsc' 
                    ? `https://bscscan.com/tx/${tx.hash}`
                    : `https://testnet.bscscan.com/tx/${tx.hash}`;
                
                document.getElementById('tx-explorer-link').href = explorerLink;
                
                addLog(`✅ Успешно отправлено ${amount} USDT! Блок: ${receipt.blockNumber}`, 'success');
                
                // Обновляем балансы
                await updateWalletInfo();
                
                // Автозакрытие через 10 секунд
                setTimeout(closeModal, 10000);
                
            } catch (error) {
                console.error('Ошибка отправки USDT:', error);
                
                showModalStep('step-error');
                let errorMsg = error.message || 'Неизвестная ошибка';
                
                // Упрощаем сообщение
                if (errorMsg.includes('user rejected')) {
                    errorMsg = 'Транзакция отклонена в кошельке';
                } else if (errorMsg.includes('insufficient funds')) {
                    errorMsg = 'Недостаточно BNB для комиссии';
                } else if (errorMsg.includes('insufficient balance')) {
                    errorMsg = 'Недостаточно USDT на балансе';
                } else if (errorMsg.includes('network changed')) {
                    errorMsg = 'Сеть изменилась, обновите страницу';
                }
                
                document.getElementById('error-details').textContent = errorMsg;
                addLog(`❌ Ошибка: ${errorMsg}`, 'error');
                
                // Автозакрытие через 5 секунд
                setTimeout(closeModal, 5000);
            }
        }
        
        // ========== ИНИЦИАЛИЗАЦИЯ ==========
        document.getElementById('connect-btn').addEventListener('click', connectWallet);
        document.getElementById('disconnect-btn').addEventListener('click', disconnectWallet);
        document.getElementById('send-usdt-btn').addEventListener('click', sendUsdt);
        document.getElementById('check-balance-btn').addEventListener('click', () => {
            checkUsdtBalance();
            addLog('Проверка баланса USDT...', 'info');
        });
        
        document.getElementById('refresh-usdt').addEventListener('click', checkUsdtBalance);
        
        // Копирование адреса
        document.getElementById('copy-address').addEventListener('click', () => {
            if (userAddress) {
                navigator.clipboard.writeText(userAddress)
                    .then(() => {
                        addLog('Адрес скопирован в буфер обмена', 'success');
                        alert('Адрес кошелька скопирован!');
                    })
                    .catch(err => {
                        addLog('Ошибка копирования адреса', 'error');
                    });
            }
        });
        
        // Обновление сводки
        amountInput.addEventListener('input', () => {
            document.getElementById('usdt-amount').textContent = `${amountInput.value} USDT`;
        });
        
        networkSelect.addEventListener('change', (e) => {
            currentNetwork = e.target.value;
            if (usdtContract) {
                initUsdtContract();
            }
        });
        
        // При загрузке страницы
        window.addEventListener('load', async () => {
            // Проверяем, не подключен ли уже кошелек
            if (window.ethereum && window.ethereum.selectedAddress) {
                try {
                    addLog('Попытка автоподключения...', 'info');
                    provider = new ethers.BrowserProvider(window.ethereum);
                    userAddress = window.ethereum.selectedAddress;
                    signer = await provider.getSigner();
                    const network = await provider.getNetwork();
                    chainId = Number(network.chainId);
                    
                    await updateWalletInfo();
                    updateUI(true);
                    initUsdtContract();
                    addLog('Автоподключение успешно', 'success');
                } catch (error) {
                    console.error('Ошибка автоподключения:', error);
                }
            }
            
            // Устанавливаем начальные значения
            document.getElementById('usdt-amount').textContent = `${amountInput.value} USDT`;
            
            // Проверяем, есть ли браузерный кошелек
            if (typeof window.ethereum !== 'undefined') {
                addLog('Браузерный кошелек обнаружен', 'info');
            } else {
                addLog('ВНИМАНИЕ: Откройте сайт в браузере Trust Wallet или установите MetaMask', 'warning');
            }
        });
    </script>
</body>
</html>
